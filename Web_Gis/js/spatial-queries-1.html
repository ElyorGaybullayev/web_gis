<!DOCTYPE html>
<html lang="" xml:lang="">

<!-- Mirrored from 132.72.155.230:3838/js/spatial-queries-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jan 2022 06:43:40 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Spatial Queries | Introduction to Web Mapping</title>
  <meta name="description" content="Chapter 11 Spatial Queries | Introduction to Web Mapping" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Spatial Queries | Introduction to Web Mapping" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Chapter 11 Spatial Queries | Introduction to Web Mapping" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Spatial Queries | Introduction to Web Mapping" />
  
  <meta name="twitter:description" content="Chapter 11 Spatial Queries | Introduction to Web Mapping" />
  

<meta name="author" content="Michael Dorman" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="non-spatial-queries-1.html"/>
<link rel="next" href="client-side-geoprocessing.html"/>
<script src="libs/header-attrs/header-attrs.js"></script>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections/anchor-sections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-134641614-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-134641614-1');
</script>



<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="css/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<a href="index.html"><img width="90%" style="margin: 5% 5% 0% 5%" src="images/BGUsig3E.svg"></a>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#what-is-web-mapping"><i class="fa fa-check"></i><b>0.1</b> What is web mapping?</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#what-is-javascript"><i class="fa fa-check"></i><b>0.2</b> What is JavaScript?</a></li>
<li class="chapter" data-level="0.3" data-path="index.html"><a href="index.html#why-use-javascript-for-web-mapping"><i class="fa fa-check"></i><b>0.3</b> Why use JavaScript for web mapping?</a></li>
<li class="chapter" data-level="0.4" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i><b>0.4</b> Learning objectives</a></li>
<li class="chapter" data-level="0.5" data-path="index.html"><a href="index.html#software"><i class="fa fa-check"></i><b>0.5</b> Software</a></li>
<li class="chapter" data-level="0.6" data-path="index.html"><a href="index.html#background-knowledge"><i class="fa fa-check"></i><b>0.6</b> Background knowledge</a></li>
<li class="chapter" data-level="0.7" data-path="index.html"><a href="index.html#online-version"><i class="fa fa-check"></i><b>0.7</b> Online version</a></li>
<li class="chapter" data-level="0.8" data-path="index.html"><a href="index.html#acknowledgments"><i class="fa fa-check"></i><b>0.8</b> Acknowledgments</a></li>
</ul></li>
<li class="part"><span><b>I Introduction to Web Technologies</b></span></li>
<li class="chapter" data-level="1" data-path="html.html"><a href="html.html"><i class="fa fa-check"></i><b>1</b> HTML</a>
<ul>
<li class="chapter" data-level="1.1" data-path="html.html"><a href="html.html#introduction"><i class="fa fa-check"></i><b>1.1</b> Introduction</a></li>
<li class="chapter" data-level="1.2" data-path="html.html"><a href="html.html#how-do-people-access-the-web"><i class="fa fa-check"></i><b>1.2</b> How do people access the web?</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="html.html"><a href="html.html#web-browsers"><i class="fa fa-check"></i><b>1.2.1</b> Web browsers</a></li>
<li class="chapter" data-level="1.2.2" data-path="html.html"><a href="html.html#web-servers"><i class="fa fa-check"></i><b>1.2.2</b> Web servers</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="html.html"><a href="html.html#web-pages"><i class="fa fa-check"></i><b>1.3</b> Web pages</a></li>
<li class="chapter" data-level="1.4" data-path="html.html"><a href="html.html#text-editors"><i class="fa fa-check"></i><b>1.4</b> Text editors</a></li>
<li class="chapter" data-level="1.5" data-path="html.html"><a href="html.html#what-is-html"><i class="fa fa-check"></i><b>1.5</b> What is HTML?</a>
<ul>
<li class="chapter" data-level="1.5.1" data-path="html.html"><a href="html.html#overview-html"><i class="fa fa-check"></i><b>1.5.1</b> Overview</a></li>
<li class="chapter" data-level="1.5.2" data-path="html.html"><a href="html.html#html-comments"><i class="fa fa-check"></i><b>1.5.2</b> HTML comments</a></li>
<li class="chapter" data-level="1.5.3" data-path="html.html"><a href="html.html#block-vs-inline"><i class="fa fa-check"></i><b>1.5.3</b> Block vs. inline</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="html.html"><a href="html.html#common-html-elements"><i class="fa fa-check"></i><b>1.6</b> Common HTML elements</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="html.html"><a href="html.html#html-element-types"><i class="fa fa-check"></i><b>1.6.1</b> HTML element types</a></li>
<li class="chapter" data-level="1.6.2" data-path="html.html"><a href="html.html#html-structure"><i class="fa fa-check"></i><b>1.6.2</b> Structure</a></li>
<li class="chapter" data-level="1.6.3" data-path="html.html"><a href="html.html#title-and-metadata"><i class="fa fa-check"></i><b>1.6.3</b> Title and metadata</a></li>
<li class="chapter" data-level="1.6.4" data-path="html.html"><a href="html.html#styling-and-scripts"><i class="fa fa-check"></i><b>1.6.4</b> Styling and scripts</a></li>
<li class="chapter" data-level="1.6.5" data-path="html.html"><a href="html.html#headings-and-paragraphs"><i class="fa fa-check"></i><b>1.6.5</b> Headings and paragraphs</a></li>
<li class="chapter" data-level="1.6.6" data-path="html.html"><a href="html.html#font-formatting"><i class="fa fa-check"></i><b>1.6.6</b> Font formatting</a></li>
<li class="chapter" data-level="1.6.7" data-path="html.html"><a href="html.html#spacing"><i class="fa fa-check"></i><b>1.6.7</b> Spacing</a></li>
<li class="chapter" data-level="1.6.8" data-path="html.html"><a href="html.html#html-lists"><i class="fa fa-check"></i><b>1.6.8</b> Lists</a></li>
<li class="chapter" data-level="1.6.9" data-path="html.html"><a href="html.html#html-links"><i class="fa fa-check"></i><b>1.6.9</b> Links</a></li>
<li class="chapter" data-level="1.6.10" data-path="html.html"><a href="html.html#images"><i class="fa fa-check"></i><b>1.6.10</b> Images</a></li>
<li class="chapter" data-level="1.6.11" data-path="html.html"><a href="html.html#tables"><i class="fa fa-check"></i><b>1.6.11</b> Tables</a></li>
<li class="chapter" data-level="1.6.12" data-path="html.html"><a href="html.html#grouping"><i class="fa fa-check"></i><b>1.6.12</b> Grouping</a></li>
<li class="chapter" data-level="1.6.13" data-path="html.html"><a href="html.html#input-elements"><i class="fa fa-check"></i><b>1.6.13</b> Input elements</a></li>
</ul></li>
<li class="chapter" data-level="1.7" data-path="html.html"><a href="html.html#id-class-and-style-attributes"><i class="fa fa-check"></i><b>1.7</b> <code>id</code>, <code>class</code>, and <code>style</code> attributes</a>
<ul>
<li class="chapter" data-level="1.7.1" data-path="html.html"><a href="html.html#overview-id-class-and-style-attributes"><i class="fa fa-check"></i><b>1.7.1</b> Overview</a></li>
<li class="chapter" data-level="1.7.2" data-path="html.html"><a href="html.html#id"><i class="fa fa-check"></i><b>1.7.2</b> <code>id</code></a></li>
<li class="chapter" data-level="1.7.3" data-path="html.html"><a href="html.html#html-class"><i class="fa fa-check"></i><b>1.7.3</b> <code>class</code></a></li>
<li class="chapter" data-level="1.7.4" data-path="html.html"><a href="html.html#style-2"><i class="fa fa-check"></i><b>1.7.4</b> <code>style</code></a></li>
</ul></li>
<li class="chapter" data-level="1.8" data-path="html.html"><a href="html.html#code-layout"><i class="fa fa-check"></i><b>1.8</b> Code layout</a></li>
<li class="chapter" data-level="1.9" data-path="html.html"><a href="html.html#inspecting-elements"><i class="fa fa-check"></i><b>1.9</b> Inspecting elements</a></li>
<li class="chapter" data-level="1.10" data-path="html.html"><a href="html.html#exercise"><i class="fa fa-check"></i><b>1.10</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="css.html"><a href="css.html"><i class="fa fa-check"></i><b>2</b> CSS</a>
<ul>
<li class="chapter" data-level="2.1" data-path="css.html"><a href="css.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="css.html"><a href="css.html#what-is-css"><i class="fa fa-check"></i><b>2.2</b> What is CSS?</a></li>
<li class="chapter" data-level="2.3" data-path="css.html"><a href="css.html#css-rules"><i class="fa fa-check"></i><b>2.3</b> CSS rules</a></li>
<li class="chapter" data-level="2.4" data-path="css.html"><a href="css.html#css-selectors"><i class="fa fa-check"></i><b>2.4</b> CSS selectors</a>
<ul>
<li class="chapter" data-level="2.4.1" data-path="css.html"><a href="css.html#overview-css-selectors"><i class="fa fa-check"></i><b>2.4.1</b> Overview</a></li>
<li class="chapter" data-level="2.4.2" data-path="css.html"><a href="css.html#type-selector"><i class="fa fa-check"></i><b>2.4.2</b> Type selector</a></li>
<li class="chapter" data-level="2.4.3" data-path="css.html"><a href="css.html#class-selector"><i class="fa fa-check"></i><b>2.4.3</b> Class selector</a></li>
<li class="chapter" data-level="2.4.4" data-path="css.html"><a href="css.html#id-selector"><i class="fa fa-check"></i><b>2.4.4</b> ID selector</a></li>
<li class="chapter" data-level="2.4.5" data-path="css.html"><a href="css.html#descendant-selector"><i class="fa fa-check"></i><b>2.4.5</b> Descendant selector</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="css.html"><a href="css.html#css-conflicts"><i class="fa fa-check"></i><b>2.5</b> CSS conflicts</a></li>
<li class="chapter" data-level="2.6" data-path="css.html"><a href="css.html#css-inheritance"><i class="fa fa-check"></i><b>2.6</b> CSS inheritance</a></li>
<li class="chapter" data-level="2.7" data-path="css.html"><a href="css.html#linking-css-to-html"><i class="fa fa-check"></i><b>2.7</b> Linking CSS to HTML</a>
<ul>
<li class="chapter" data-level="2.7.1" data-path="css.html"><a href="css.html#methods-for-linking-css"><i class="fa fa-check"></i><b>2.7.1</b> Methods for linking CSS</a></li>
<li class="chapter" data-level="2.7.2" data-path="css.html"><a href="css.html#inline-css"><i class="fa fa-check"></i><b>2.7.2</b> Inline CSS</a></li>
<li class="chapter" data-level="2.7.3" data-path="css.html"><a href="css.html#embedded-css"><i class="fa fa-check"></i><b>2.7.3</b> Embedded CSS</a></li>
<li class="chapter" data-level="2.7.4" data-path="css.html"><a href="css.html#external-css"><i class="fa fa-check"></i><b>2.7.4</b> External CSS</a></li>
</ul></li>
<li class="chapter" data-level="2.8" data-path="css.html"><a href="css.html#css-properties"><i class="fa fa-check"></i><b>2.8</b> CSS properties</a>
<ul>
<li class="chapter" data-level="2.8.1" data-path="css.html"><a href="css.html#overview-css-properties"><i class="fa fa-check"></i><b>2.8.1</b> Overview</a></li>
<li class="chapter" data-level="2.8.2" data-path="css.html"><a href="css.html#color"><i class="fa fa-check"></i><b>2.8.2</b> Color</a></li>
<li class="chapter" data-level="2.8.3" data-path="css.html"><a href="css.html#text"><i class="fa fa-check"></i><b>2.8.3</b> Text</a></li>
<li class="chapter" data-level="2.8.4" data-path="css.html"><a href="css.html#boxes"><i class="fa fa-check"></i><b>2.8.4</b> Boxes</a></li>
</ul></li>
<li class="chapter" data-level="2.9" data-path="css.html"><a href="css.html#hurricane-scale"><i class="fa fa-check"></i><b>2.9</b> Hurricane scale example</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="css.html"><a href="css.html#html-contents"><i class="fa fa-check"></i><b>2.9.1</b> HTML contents</a></li>
<li class="chapter" data-level="2.9.2" data-path="css.html"><a href="css.html#css-styling"><i class="fa fa-check"></i><b>2.9.2</b> CSS styling</a></li>
</ul></li>
<li class="chapter" data-level="2.10" data-path="css.html"><a href="css.html#example-map-description"><i class="fa fa-check"></i><b>2.10</b> Map description example</a>
<ul>
<li class="chapter" data-level="2.10.1" data-path="css.html"><a href="css.html#html-contents-1"><i class="fa fa-check"></i><b>2.10.1</b> HTML contents</a></li>
<li class="chapter" data-level="2.10.2" data-path="css.html"><a href="css.html#example-map-description-box-position"><i class="fa fa-check"></i><b>2.10.2</b> CSS styling: box position</a></li>
<li class="chapter" data-level="2.10.3" data-path="css.html"><a href="css.html#css-styling-final-touches"><i class="fa fa-check"></i><b>2.10.3</b> CSS styling: final touches</a></li>
<li class="chapter" data-level="2.10.4" data-path="css.html"><a href="css.html#adding-map-in-the-background"><i class="fa fa-check"></i><b>2.10.4</b> Adding map in the background</a></li>
</ul></li>
<li class="chapter" data-level="2.11" data-path="css.html"><a href="css.html#exercise-1"><i class="fa fa-check"></i><b>2.11</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="javascript-basics.html"><a href="javascript-basics.html"><i class="fa fa-check"></i><b>3</b> JavaScript Basics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="javascript-basics.html"><a href="javascript-basics.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="javascript-basics.html"><a href="javascript-basics.html#what-is-javascript-1"><i class="fa fa-check"></i><b>3.2</b> What is JavaScript?</a></li>
<li class="chapter" data-level="3.3" data-path="javascript-basics.html"><a href="javascript-basics.html#client-side-vs.-server-side"><i class="fa fa-check"></i><b>3.3</b> Client-side vs. server-side</a></li>
<li class="chapter" data-level="3.4" data-path="javascript-basics.html"><a href="javascript-basics.html#the-javascript-console"><i class="fa fa-check"></i><b>3.4</b> The JavaScript console</a></li>
<li class="chapter" data-level="3.5" data-path="javascript-basics.html"><a href="javascript-basics.html#assignment"><i class="fa fa-check"></i><b>3.5</b> Assignment</a></li>
<li class="chapter" data-level="3.6" data-path="javascript-basics.html"><a href="javascript-basics.html#data-types"><i class="fa fa-check"></i><b>3.6</b> Data types</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="javascript-basics.html"><a href="javascript-basics.html#overview-data-types"><i class="fa fa-check"></i><b>3.6.1</b> Overview</a></li>
<li class="chapter" data-level="3.6.2" data-path="javascript-basics.html"><a href="javascript-basics.html#primitive-data-types"><i class="fa fa-check"></i><b>3.6.2</b> Primitive data types</a></li>
<li class="chapter" data-level="3.6.3" data-path="javascript-basics.html"><a href="javascript-basics.html#objects-data-type"><i class="fa fa-check"></i><b>3.6.3</b> Objects</a></li>
<li class="chapter" data-level="3.6.4" data-path="javascript-basics.html"><a href="javascript-basics.html#checking-type-of-variables"><i class="fa fa-check"></i><b>3.6.4</b> Checking type of variables</a></li>
</ul></li>
<li class="chapter" data-level="3.7" data-path="javascript-basics.html"><a href="javascript-basics.html#functions"><i class="fa fa-check"></i><b>3.7</b> Functions</a></li>
<li class="chapter" data-level="3.8" data-path="javascript-basics.html"><a href="javascript-basics.html#methods"><i class="fa fa-check"></i><b>3.8</b> Methods</a>
<ul>
<li class="chapter" data-level="3.8.1" data-path="javascript-basics.html"><a href="javascript-basics.html#what-are-methods"><i class="fa fa-check"></i><b>3.8.1</b> What are methods?</a></li>
<li class="chapter" data-level="3.8.2" data-path="javascript-basics.html"><a href="javascript-basics.html#array-methods"><i class="fa fa-check"></i><b>3.8.2</b> Array methods</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="javascript-basics.html"><a href="javascript-basics.html#scope"><i class="fa fa-check"></i><b>3.9</b> Scope</a></li>
<li class="chapter" data-level="3.10" data-path="javascript-basics.html"><a href="javascript-basics.html#flow-control"><i class="fa fa-check"></i><b>3.10</b> Flow control</a>
<ul>
<li class="chapter" data-level="3.10.1" data-path="javascript-basics.html"><a href="javascript-basics.html#what-is-flow-control"><i class="fa fa-check"></i><b>3.10.1</b> What is flow control?</a></li>
<li class="chapter" data-level="3.10.2" data-path="javascript-basics.html"><a href="javascript-basics.html#conditionals"><i class="fa fa-check"></i><b>3.10.2</b> Conditionals</a></li>
<li class="chapter" data-level="3.10.3" data-path="javascript-basics.html"><a href="javascript-basics.html#loops"><i class="fa fa-check"></i><b>3.10.3</b> Loops</a></li>
</ul></li>
<li class="chapter" data-level="3.11" data-path="javascript-basics.html"><a href="javascript-basics.html#javascript-object-notation-json"><i class="fa fa-check"></i><b>3.11</b> JavaScript Object Notation (JSON)</a>
<ul>
<li class="chapter" data-level="3.11.1" data-path="javascript-basics.html"><a href="javascript-basics.html#javascript-json"><i class="fa fa-check"></i><b>3.11.1</b> JSON</a></li>
<li class="chapter" data-level="3.11.2" data-path="javascript-basics.html"><a href="javascript-basics.html#geojson"><i class="fa fa-check"></i><b>3.11.2</b> GeoJSON</a></li>
</ul></li>
<li class="chapter" data-level="3.12" data-path="javascript-basics.html"><a href="javascript-basics.html#exercise-2"><i class="fa fa-check"></i><b>3.12</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html"><i class="fa fa-check"></i><b>4</b> JavaScript Interactivity</a>
<ul>
<li class="chapter" data-level="4.1" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#the-document-object-model"><i class="fa fa-check"></i><b>4.2</b> The Document Object Model (DOM)</a></li>
<li class="chapter" data-level="4.3" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#accessing-and-modifying-elements"><i class="fa fa-check"></i><b>4.3</b> Accessing and modifying elements</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#overview-accessing-and_modifying"><i class="fa fa-check"></i><b>4.3.1</b> Overview</a></li>
<li class="chapter" data-level="4.3.2" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#accessing-elements"><i class="fa fa-check"></i><b>4.3.2</b> Accessing elements</a></li>
<li class="chapter" data-level="4.3.3" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#getting-element-properties"><i class="fa fa-check"></i><b>4.3.3</b> Getting element properties</a></li>
<li class="chapter" data-level="4.3.4" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#modifying-elements"><i class="fa fa-check"></i><b>4.3.4</b> Modifying elements</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#event-listeners"><i class="fa fa-check"></i><b>4.4</b> Event listeners</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#event-types"><i class="fa fa-check"></i><b>4.4.1</b> Event types</a></li>
<li class="chapter" data-level="4.4.2" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#binding-event-listeners"><i class="fa fa-check"></i><b>4.4.2</b> Binding event listeners</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#hello-example"><i class="fa fa-check"></i><b>4.5</b> Hello example</a></li>
<li class="chapter" data-level="4.6" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#poles-example"><i class="fa fa-check"></i><b>4.6</b> Poles example</a></li>
<li class="chapter" data-level="4.7" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#operating-on-selection"><i class="fa fa-check"></i><b>4.7</b> Operating on multiple selections</a>
<ul>
<li class="chapter" data-level="4.7.1" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#example-page"><i class="fa fa-check"></i><b>4.7.1</b> Example page</a></li>
<li class="chapter" data-level="4.7.2" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#making-multiple-selections"><i class="fa fa-check"></i><b>4.7.2</b> Making multiple selections</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#getting-and-setting-input-values"><i class="fa fa-check"></i><b>4.8</b> Getting and setting input values</a></li>
<li class="chapter" data-level="4.9" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#multiple-event-listeners"><i class="fa fa-check"></i><b>4.9</b> Multiple event listeners</a></li>
<li class="chapter" data-level="4.10" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#the-event-object"><i class="fa fa-check"></i><b>4.10</b> The event object</a>
<ul>
<li class="chapter" data-level="4.10.1" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#event-object-properties"><i class="fa fa-check"></i><b>4.10.1</b> Event object properties</a></li>
<li class="chapter" data-level="4.10.2" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#event-target"><i class="fa fa-check"></i><b>4.10.2</b> The <code>.target</code> property</a></li>
</ul></li>
<li class="chapter" data-level="4.11" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#modifying-page-based-on-data"><i class="fa fa-check"></i><b>4.11</b> Modifying page based on data</a></li>
<li class="chapter" data-level="4.12" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#working-with-user-input"><i class="fa fa-check"></i><b>4.12</b> Calculator example</a></li>
<li class="chapter" data-level="4.13" data-path="javascript-interactivity.html"><a href="javascript-interactivity.html#exercise-3"><i class="fa fa-check"></i><b>4.13</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="web-servers-1.html"><a href="web-servers-1.html"><i class="fa fa-check"></i><b>5</b> Web Servers</a>
<ul>
<li class="chapter" data-level="5.1" data-path="web-servers-1.html"><a href="web-servers-1.html#introduction-4"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="web-servers-1.html"><a href="web-servers-1.html#web-servers-2"><i class="fa fa-check"></i><b>5.2</b> Web servers</a></li>
<li class="chapter" data-level="5.3" data-path="web-servers-1.html"><a href="web-servers-1.html#communicating-through-http"><i class="fa fa-check"></i><b>5.3</b> Communicating through HTTP</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="web-servers-1.html"><a href="web-servers-1.html#web-protocols-and-http"><i class="fa fa-check"></i><b>5.3.1</b> Web protocols and HTTP</a></li>
<li class="chapter" data-level="5.3.2" data-path="web-servers-1.html"><a href="web-servers-1.html#http-methods"><i class="fa fa-check"></i><b>5.3.2</b> HTTP methods</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="web-servers-1.html"><a href="web-servers-1.html#static-vs-dynamic-servers"><i class="fa fa-check"></i><b>5.4</b> Static vs. dynamic servers</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="web-servers-1.html"><a href="web-servers-1.html#overview"><i class="fa fa-check"></i><b>5.4.1</b> Overview</a></li>
<li class="chapter" data-level="5.4.2" data-path="web-servers-1.html"><a href="web-servers-1.html#static-servers"><i class="fa fa-check"></i><b>5.4.2</b> Static servers</a></li>
<li class="chapter" data-level="5.4.3" data-path="web-servers-1.html"><a href="web-servers-1.html#dynamic-servers"><i class="fa fa-check"></i><b>5.4.3</b> Dynamic servers</a></li>
<li class="chapter" data-level="5.4.4" data-path="web-servers-1.html"><a href="web-servers-1.html#software-1"><i class="fa fa-check"></i><b>5.4.4</b> Software</a></li>
<li class="chapter" data-level="5.4.5" data-path="web-servers-1.html"><a href="web-servers-1.html#practical-considerations"><i class="fa fa-check"></i><b>5.4.5</b> Practical considerations</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="web-servers-1.html"><a href="web-servers-1.html#urls-and-file-structure"><i class="fa fa-check"></i><b>5.5</b> URLs and file structure</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="web-servers-1.html"><a href="web-servers-1.html#urls-and-index-html"><i class="fa fa-check"></i><b>5.5.1</b> URLs and <code>index.html</code></a></li>
<li class="chapter" data-level="5.5.2" data-path="web-servers-1.html"><a href="web-servers-1.html#file-structure"><i class="fa fa-check"></i><b>5.5.2</b> File structure</a></li>
<li class="chapter" data-level="5.5.3" data-path="web-servers-1.html"><a href="web-servers-1.html#relative-paths"><i class="fa fa-check"></i><b>5.5.3</b> Relative paths</a></li>
<li class="chapter" data-level="5.5.4" data-path="web-servers-1.html"><a href="web-servers-1.html#css-and-javasccript"><i class="fa fa-check"></i><b>5.5.4</b> CSS and JavaScript</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="web-servers-1.html"><a href="web-servers-1.html#running-a-static-server"><i class="fa fa-check"></i><b>5.6</b> Running a static server</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="web-servers-1.html"><a href="web-servers-1.html#overview-running-static-server"><i class="fa fa-check"></i><b>5.6.1</b> Overview</a></li>
<li class="chapter" data-level="5.6.2" data-path="web-servers-1.html"><a href="web-servers-1.html#local-with-python"><i class="fa fa-check"></i><b>5.6.2</b> Local with Python</a></li>
<li class="chapter" data-level="5.6.3" data-path="web-servers-1.html"><a href="web-servers-1.html#remote-with-github-pages"><i class="fa fa-check"></i><b>5.6.3</b> Remote with GitHub Pages</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Web Mapping with Leaflet</b></span></li>
<li class="chapter" data-level="6" data-path="leaflet.html"><a href="leaflet.html"><i class="fa fa-check"></i><b>6</b> Leaflet</a>
<ul>
<li class="chapter" data-level="6.1" data-path="leaflet.html"><a href="leaflet.html#introduction-5"><i class="fa fa-check"></i><b>6.1</b> Introduction</a></li>
<li class="chapter" data-level="6.2" data-path="leaflet.html"><a href="leaflet.html#what-is-web-map"><i class="fa fa-check"></i><b>6.2</b> What is a web map?</a></li>
<li class="chapter" data-level="6.3" data-path="leaflet.html"><a href="leaflet.html#what-is-leaflet"><i class="fa fa-check"></i><b>6.3</b> What is Leaflet?</a></li>
<li class="chapter" data-level="6.4" data-path="leaflet.html"><a href="leaflet.html#alternatives-to-leaflet"><i class="fa fa-check"></i><b>6.4</b> Alternatives to Leaflet</a></li>
<li class="chapter" data-level="6.5" data-path="leaflet.html"><a href="leaflet.html#creating-a-basic-web-map"><i class="fa fa-check"></i><b>6.5</b> Creating a basic web map</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="leaflet.html"><a href="leaflet.html#overview-creating-a-basic-web-map"><i class="fa fa-check"></i><b>6.5.1</b> Overview</a></li>
<li class="chapter" data-level="6.5.2" data-path="leaflet.html"><a href="leaflet.html#web-page-setup"><i class="fa fa-check"></i><b>6.5.2</b> Web page setup</a></li>
<li class="chapter" data-level="6.5.3" data-path="leaflet.html"><a href="leaflet.html#javascript-libraries"><i class="fa fa-check"></i><b>6.5.3</b> JavaScript libraries</a></li>
<li class="chapter" data-level="6.5.4" data-path="leaflet.html"><a href="leaflet.html#including-a-library"><i class="fa fa-check"></i><b>6.5.4</b> Including a library</a></li>
<li class="chapter" data-level="6.5.5" data-path="leaflet.html"><a href="leaflet.html#loading-a-local-script"><i class="fa fa-check"></i><b>6.5.5</b> Loading a local script</a></li>
<li class="chapter" data-level="6.5.6" data-path="leaflet.html"><a href="leaflet.html#loading-a-remote-script"><i class="fa fa-check"></i><b>6.5.6</b> Loading a remote script</a></li>
<li class="chapter" data-level="6.5.7" data-path="leaflet.html"><a href="leaflet.html#including-leaflet-css-js"><i class="fa fa-check"></i><b>6.5.7</b> Including Leaflet CSS and JavaScript</a></li>
<li class="chapter" data-level="6.5.8" data-path="leaflet.html"><a href="leaflet.html#adding-map-div"><i class="fa fa-check"></i><b>6.5.8</b> Adding map <code>&lt;div&gt;</code></a></li>
<li class="chapter" data-level="6.5.9" data-path="leaflet.html"><a href="leaflet.html#creating-map-object"><i class="fa fa-check"></i><b>6.5.9</b> Creating a map object</a></li>
<li class="chapter" data-level="6.5.10" data-path="leaflet.html"><a href="leaflet.html#what-are-tile-layers"><i class="fa fa-check"></i><b>6.5.10</b> What are tile layers?</a></li>
<li class="chapter" data-level="6.5.11" data-path="leaflet.html"><a href="leaflet.html#adding-a-tile-layer"><i class="fa fa-check"></i><b>6.5.11</b> Adding a tile layer</a></li>
<li class="chapter" data-level="6.5.12" data-path="leaflet.html"><a href="leaflet.html#tile-layer-providers"><i class="fa fa-check"></i><b>6.5.12</b> Tile layer providers</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="leaflet.html"><a href="leaflet.html#adding-vector-layers"><i class="fa fa-check"></i><b>6.6</b> Adding vector layers</a>
<ul>
<li class="chapter" data-level="6.6.1" data-path="leaflet.html"><a href="leaflet.html#overview-adding-vector-layers"><i class="fa fa-check"></i><b>6.6.1</b> Overview</a></li>
<li class="chapter" data-level="6.6.2" data-path="leaflet.html"><a href="leaflet.html#adding-markers"><i class="fa fa-check"></i><b>6.6.2</b> Adding markers</a></li>
<li class="chapter" data-level="6.6.3" data-path="leaflet.html"><a href="leaflet.html#adding-lines"><i class="fa fa-check"></i><b>6.6.3</b> Adding lines</a></li>
<li class="chapter" data-level="6.6.4" data-path="leaflet.html"><a href="leaflet.html#adding-polygons"><i class="fa fa-check"></i><b>6.6.4</b> Adding polygons</a></li>
<li class="chapter" data-level="6.6.5" data-path="leaflet.html"><a href="leaflet.html#other-layer-types"><i class="fa fa-check"></i><b>6.6.5</b> Other layer types</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="leaflet.html"><a href="leaflet.html#adding-popups"><i class="fa fa-check"></i><b>6.7</b> Adding popups</a></li>
<li class="chapter" data-level="6.8" data-path="leaflet.html"><a href="leaflet.html#adding-a-description"><i class="fa fa-check"></i><b>6.8</b> Adding a description</a></li>
<li class="chapter" data-level="6.9" data-path="leaflet.html"><a href="leaflet.html#introducing-map-events"><i class="fa fa-check"></i><b>6.9</b> Introducing map events</a></li>
<li class="chapter" data-level="6.10" data-path="leaflet.html"><a href="leaflet.html#exercise-06"><i class="fa fa-check"></i><b>6.10</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="geojson-1.html"><a href="geojson-1.html"><i class="fa fa-check"></i><b>7</b> GeoJSON</a>
<ul>
<li class="chapter" data-level="7.1" data-path="geojson-1.html"><a href="geojson-1.html#introduction-6"><i class="fa fa-check"></i><b>7.1</b> Introduction</a></li>
<li class="chapter" data-level="7.2" data-path="geojson-1.html"><a href="geojson-1.html#what-is-geojson"><i class="fa fa-check"></i><b>7.2</b> What is GeoJSON?</a></li>
<li class="chapter" data-level="7.3" data-path="geojson-1.html"><a href="geojson-1.html#geojson-structure"><i class="fa fa-check"></i><b>7.3</b> GeoJSON structure</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="geojson-1.html"><a href="geojson-1.html#overview-geojson"><i class="fa fa-check"></i><b>7.3.1</b> Overview</a></li>
<li class="chapter" data-level="7.3.2" data-path="geojson-1.html"><a href="geojson-1.html#geometries"><i class="fa fa-check"></i><b>7.3.2</b> Geometries</a></li>
<li class="chapter" data-level="7.3.3" data-path="geojson-1.html"><a href="geojson-1.html#features"><i class="fa fa-check"></i><b>7.3.3</b> Features</a></li>
<li class="chapter" data-level="7.3.4" data-path="geojson-1.html"><a href="geojson-1.html#feature-collections"><i class="fa fa-check"></i><b>7.3.4</b> Feature collections</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="geojson-1.html"><a href="geojson-1.html#editing-geojson"><i class="fa fa-check"></i><b>7.4</b> Editing GeoJSON</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="geojson-1.html"><a href="geojson-1.html#geojson-io"><i class="fa fa-check"></i><b>7.4.1</b> geojson.io</a></li>
<li class="chapter" data-level="7.4.2" data-path="geojson-1.html"><a href="geojson-1.html#mapshaper"><i class="fa fa-check"></i><b>7.4.2</b> mapshaper</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="geojson-1.html"><a href="geojson-1.html#adding-geojson-to-leaflet-map"><i class="fa fa-check"></i><b>7.5</b> Adding GeoJSON to Leaflet map</a></li>
<li class="chapter" data-level="7.6" data-path="geojson-1.html"><a href="geojson-1.html#geojson-viewer"><i class="fa fa-check"></i><b>7.6</b> GeoJSON viewer example</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="geojson-1.html"><a href="geojson-1.html#viewer-structure"><i class="fa fa-check"></i><b>7.6.1</b> Viewer structure</a></li>
<li class="chapter" data-level="7.6.2" data-path="geojson-1.html"><a href="geojson-1.html#viewer-html-and-css"><i class="fa fa-check"></i><b>7.6.2</b> HTML and CSS</a></li>
<li class="chapter" data-level="7.6.3" data-path="geojson-1.html"><a href="geojson-1.html#base-map"><i class="fa fa-check"></i><b>7.6.3</b> Base map</a></li>
<li class="chapter" data-level="7.6.4" data-path="geojson-1.html"><a href="geojson-1.html#adding-an-event-listener"><i class="fa fa-check"></i><b>7.6.4</b> Adding an event listener</a></li>
<li class="chapter" data-level="7.6.5" data-path="geojson-1.html"><a href="geojson-1.html#using-layer-groups"><i class="fa fa-check"></i><b>7.6.5</b> Using layer groups</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="geojson-1.html"><a href="geojson-1.html#ajax"><i class="fa fa-check"></i><b>7.7</b> Ajax and the <code>fetch</code> API</a>
<ul>
<li class="chapter" data-level="7.7.1" data-path="geojson-1.html"><a href="geojson-1.html#overview-ajax"><i class="fa fa-check"></i><b>7.7.1</b> What is Ajax?</a></li>
<li class="chapter" data-level="7.7.2" data-path="geojson-1.html"><a href="geojson-1.html#ajax-examples"><i class="fa fa-check"></i><b>7.7.2</b> Ajax examples</a></li>
<li class="chapter" data-level="7.7.3" data-path="geojson-1.html"><a href="geojson-1.html#making-ajax-requests-with-fetch"><i class="fa fa-check"></i><b>7.7.3</b> The <code>fetch</code> API</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="geojson-1.html"><a href="geojson-1.html#loading-geojson-files"><i class="fa fa-check"></i><b>7.8</b> Loading GeoJSON files</a>
<ul>
<li class="chapter" data-level="7.8.1" data-path="geojson-1.html"><a href="geojson-1.html#loading-local-files"><i class="fa fa-check"></i><b>7.8.1</b> Loading local files</a></li>
<li class="chapter" data-level="7.8.2" data-path="geojson-1.html"><a href="geojson-1.html#loading-remote-files"><i class="fa fa-check"></i><b>7.8.2</b> Loading remote files</a></li>
</ul></li>
<li class="chapter" data-level="7.9" data-path="geojson-1.html"><a href="geojson-1.html#exercise-4"><i class="fa fa-check"></i><b>7.9</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html"><i class="fa fa-check"></i><b>8</b> Symbology and Interactivity</a>
<ul>
<li class="chapter" data-level="8.1" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#introduction-7"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#l-geojson-options"><i class="fa fa-check"></i><b>8.2</b> <code>L.geoJSON</code> options</a></li>
<li class="chapter" data-level="8.3" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#constant-style"><i class="fa fa-check"></i><b>8.3</b> Constant style</a></li>
<li class="chapter" data-level="8.4" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#varying-style"><i class="fa fa-check"></i><b>8.4</b> Varying style</a>
<ul>
<li class="chapter" data-level="8.4.1" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#setting-varying-style"><i class="fa fa-check"></i><b>8.4.1</b> Setting varying style</a></li>
<li class="chapter" data-level="8.4.2" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#states-example"><i class="fa fa-check"></i><b>8.4.2</b> States example</a></li>
<li class="chapter" data-level="8.4.3" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#towns-example"><i class="fa fa-check"></i><b>8.4.3</b> Towns example</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#constructing-popups-from-data"><i class="fa fa-check"></i><b>8.5</b> Constructing popups from data</a></li>
<li class="chapter" data-level="8.6" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#adding-a-legend"><i class="fa fa-check"></i><b>8.6</b> Adding a legend</a>
<ul>
<li class="chapter" data-level="8.6.1" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#setting-legend-contents-with-l.control"><i class="fa fa-check"></i><b>8.6.1</b> Setting legend contents with <code>L.control</code></a></li>
<li class="chapter" data-level="8.6.2" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#using-css-to-style-the-legend"><i class="fa fa-check"></i><b>8.6.2</b> Using CSS to style the legend</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#dynamic-style"><i class="fa fa-check"></i><b>8.7</b> Dynamic style</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#styling-in-response-to-events"><i class="fa fa-check"></i><b>8.7.1</b> Styling in response to events</a></li>
<li class="chapter" data-level="8.7.2" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#dynamic-control-contents"><i class="fa fa-check"></i><b>8.7.2</b> Dynamic control contents</a></li>
<li class="chapter" data-level="8.7.3" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#linked-views"><i class="fa fa-check"></i><b>8.7.3</b> Linked views</a></li>
</ul></li>
<li class="chapter" data-level="8.8" data-path="symbology-and-interactivity.html"><a href="symbology-and-interactivity.html#exercise-08"><i class="fa fa-check"></i><b>8.8</b> Exercise</a></li>
</ul></li>
<li class="part"><span><b>III Databases</b></span></li>
<li class="chapter" data-level="9" data-path="databases.html"><a href="databases.html"><i class="fa fa-check"></i><b>9</b> Databases</a>
<ul>
<li class="chapter" data-level="9.1" data-path="databases.html"><a href="databases.html#introduction-databases"><i class="fa fa-check"></i><b>9.1</b> Introduction</a></li>
<li class="chapter" data-level="9.2" data-path="databases.html"><a href="databases.html#what-is-carto"><i class="fa fa-check"></i><b>9.2</b> What is CARTO?</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="databases.html"><a href="databases.html#the-carto-platform"><i class="fa fa-check"></i><b>9.2.1</b> The CARTO platform</a></li>
<li class="chapter" data-level="9.2.2" data-path="databases.html"><a href="databases.html#alternatives-to-carto"><i class="fa fa-check"></i><b>9.2.2</b> Alternatives to CARTO</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="databases.html"><a href="databases.html#databases-1"><i class="fa fa-check"></i><b>9.3</b> Databases</a></li>
<li class="chapter" data-level="9.4" data-path="databases.html"><a href="databases.html#spatial-databases"><i class="fa fa-check"></i><b>9.4</b> Spatial databases</a></li>
<li class="chapter" data-level="9.5" data-path="databases.html"><a href="databases.html#what-is-postgis"><i class="fa fa-check"></i><b>9.5</b> What is PostGIS?</a></li>
<li class="chapter" data-level="9.6" data-path="databases.html"><a href="databases.html#what-is-sql"><i class="fa fa-check"></i><b>9.6</b> What is SQL?</a>
<ul>
<li class="chapter" data-level="9.6.1" data-path="databases.html"><a href="databases.html#overview-sql"><i class="fa fa-check"></i><b>9.6.1</b> Overview</a></li>
<li class="chapter" data-level="9.6.2" data-path="databases.html"><a href="databases.html#non-spatial-queries"><i class="fa fa-check"></i><b>9.6.2</b> Non-spatial queries</a></li>
<li class="chapter" data-level="9.6.3" data-path="databases.html"><a href="databases.html#the-geometry-column"><i class="fa fa-check"></i><b>9.6.3</b> The geometry column</a></li>
<li class="chapter" data-level="9.6.4" data-path="databases.html"><a href="databases.html#spatial-queries"><i class="fa fa-check"></i><b>9.6.4</b> Spatial queries</a></li>
</ul></li>
<li class="chapter" data-level="9.7" data-path="databases.html"><a href="databases.html#the-carto-sql-api"><i class="fa fa-check"></i><b>9.7</b> The CARTO SQL API</a>
<ul>
<li class="chapter" data-level="9.7.1" data-path="databases.html"><a href="databases.html#api-usage"><i class="fa fa-check"></i><b>9.7.1</b> API usage</a></li>
<li class="chapter" data-level="9.7.2" data-path="databases.html"><a href="databases.html#query-example"><i class="fa fa-check"></i><b>9.7.2</b> Query example</a></li>
<li class="chapter" data-level="9.7.3" data-path="databases.html"><a href="databases.html#uploading-your-data"><i class="fa fa-check"></i><b>9.7.3</b> Uploading your data</a></li>
</ul></li>
<li class="chapter" data-level="9.8" data-path="databases.html"><a href="databases.html#carto-and-leaflet"><i class="fa fa-check"></i><b>9.8</b> CARTO and Leaflet</a></li>
<li class="chapter" data-level="9.9" data-path="databases.html"><a href="databases.html#exercise-09"><i class="fa fa-check"></i><b>9.9</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html"><i class="fa fa-check"></i><b>10</b> Non-spatial Queries</a>
<ul>
<li class="chapter" data-level="10.1" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#introduction-8"><i class="fa fa-check"></i><b>10.1</b> Introduction</a></li>
<li class="chapter" data-level="10.2" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#subsetting-with-sql"><i class="fa fa-check"></i><b>10.2</b> Subsetting with SQL</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#filtering-based-on-attributes"><i class="fa fa-check"></i><b>10.2.1</b> Filtering based on attributes</a></li>
<li class="chapter" data-level="10.2.2" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#displaying-on-a-map"><i class="fa fa-check"></i><b>10.2.2</b> Displaying on a map</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#creating-a-dropdown-menu"><i class="fa fa-check"></i><b>10.3</b> Creating a dropdown menu</a></li>
<li class="chapter" data-level="10.4" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#populating-dropdown-options"><i class="fa fa-check"></i><b>10.4</b> Populating dropdown options</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#how-many-species-do-we-have"><i class="fa fa-check"></i><b>10.4.1</b> How many species do we have?</a></li>
<li class="chapter" data-level="10.4.2" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#dropdown-menu-placeholder"><i class="fa fa-check"></i><b>10.4.2</b> Dropdown menu placeholder</a></li>
<li class="chapter" data-level="10.4.3" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#finding-unique-values"><i class="fa fa-check"></i><b>10.4.3</b> Finding unique values</a></li>
<li class="chapter" data-level="10.4.4" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#adding-options"><i class="fa fa-check"></i><b>10.4.4</b> Adding the options</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#updating-the-map"><i class="fa fa-check"></i><b>10.5</b> Updating the map</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#overview-updating-map"><i class="fa fa-check"></i><b>10.5.1</b> Overview</a></li>
<li class="chapter" data-level="10.5.2" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#manual-example"><i class="fa fa-check"></i><b>10.5.2</b> Manual example</a></li>
<li class="chapter" data-level="10.5.3" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#automatic-updating"><i class="fa fa-check"></i><b>10.5.3</b> Automatic updating</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#rearranging-the-code"><i class="fa fa-check"></i><b>10.6</b> Refactoring the code</a></li>
<li class="chapter" data-level="10.7" data-path="non-spatial-queries-1.html"><a href="non-spatial-queries-1.html#exercise-10"><i class="fa fa-check"></i><b>10.7</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html"><i class="fa fa-check"></i><b>11</b> Spatial Queries</a>
<ul>
<li class="chapter" data-level="11.1" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#introduction-9"><i class="fa fa-check"></i><b>11.1</b> Introduction</a></li>
<li class="chapter" data-level="11.2" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#adding-marker-on-click"><i class="fa fa-check"></i><b>11.2</b> Adding markers on click</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#getting-click-coordinates"><i class="fa fa-check"></i><b>11.2.1</b> Getting click coordinates</a></li>
<li class="chapter" data-level="11.2.2" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#adding-custom-marker"><i class="fa fa-check"></i><b>11.2.2</b> Adding a custom marker</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#spatial-postgis-operators"><i class="fa fa-check"></i><b>11.3</b> Spatial PostGIS operators</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#overview-postgis-operators"><i class="fa fa-check"></i><b>11.3.1</b> Overview</a></li>
<li class="chapter" data-level="11.3.2" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#geographical-distance"><i class="fa fa-check"></i><b>11.3.2</b> Geographical distance</a></li>
<li class="chapter" data-level="11.3.3" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#sphere-vs-spheroid"><i class="fa fa-check"></i><b>11.3.3</b> Sphere vs. spheroid</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#adding-nearest-points-to-map"><i class="fa fa-check"></i><b>11.4</b> Adding nearest points to map</a></li>
<li class="chapter" data-level="11.5" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#drawing-line-connectors"><i class="fa fa-check"></i><b>11.5</b> Drawing line connectors</a></li>
<li class="chapter" data-level="11.6" data-path="spatial-queries-1.html"><a href="spatial-queries-1.html#exercise-5"><i class="fa fa-check"></i><b>11.6</b> Exercise</a></li>
</ul></li>
<li class="part"><span><b>IV Advanced Topics</b></span></li>
<li class="chapter" data-level="12" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html"><i class="fa fa-check"></i><b>12</b> Client-side Geoprocessing</a>
<ul>
<li class="chapter" data-level="12.1" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#introduction-10"><i class="fa fa-check"></i><b>12.1</b> Introduction</a></li>
<li class="chapter" data-level="12.2" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#geoprocessing-with-turfjs"><i class="fa fa-check"></i><b>12.2</b> Geoprocessing with Turf.js</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#overview-turfjs"><i class="fa fa-check"></i><b>12.2.1</b> Overview</a></li>
<li class="chapter" data-level="12.2.2" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#including-the-turf-js-library"><i class="fa fa-check"></i><b>12.2.2</b> Including the Turf.js library</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#great-circle-line"><i class="fa fa-check"></i><b>12.3</b> Great Circle line</a></li>
<li class="chapter" data-level="12.4" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#continuously-updated-tin"><i class="fa fa-check"></i><b>12.4</b> Continuously updated TIN</a>
<ul>
<li class="chapter" data-level="12.4.1" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#overview-continuous-tin"><i class="fa fa-check"></i><b>12.4.1</b> Overview</a></li>
<li class="chapter" data-level="12.4.2" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#generating-random-points"><i class="fa fa-check"></i><b>12.4.2</b> Generating random points</a></li>
<li class="chapter" data-level="12.4.3" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#adding-a-tin-layer"><i class="fa fa-check"></i><b>12.4.3</b> Adding a TIN layer</a></li>
<li class="chapter" data-level="12.4.4" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#draggable-circle-markers"><i class="fa fa-check"></i><b>12.4.4</b> Draggable circle markers</a></li>
<li class="chapter" data-level="12.4.5" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#continuous-updating"><i class="fa fa-check"></i><b>12.4.5</b> Continuous updating</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#clustering"><i class="fa fa-check"></i><b>12.5</b> Clustering</a>
<ul>
<li class="chapter" data-level="12.5.1" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#overview-clustering"><i class="fa fa-check"></i><b>12.5.1</b> Overview</a></li>
<li class="chapter" data-level="12.5.2" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#processing-sets-of-features"><i class="fa fa-check"></i><b>12.5.2</b> Processing sets of features</a></li>
<li class="chapter" data-level="12.5.3" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#adding-a-convex-hull"><i class="fa fa-check"></i><b>12.5.3</b> Adding a Convex Hull</a></li>
<li class="chapter" data-level="12.5.4" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#dbscan-clustering"><i class="fa fa-check"></i><b>12.5.4</b> DBSCAN clustering</a></li>
</ul></li>
<li class="chapter" data-level="12.6" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#heatmaps-with-leafletheat"><i class="fa fa-check"></i><b>12.6</b> Heatmaps with Leaflet.heat</a></li>
<li class="chapter" data-level="12.7" data-path="client-side-geoprocessing.html"><a href="client-side-geoprocessing.html#exercise-6"><i class="fa fa-check"></i><b>12.7</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html"><i class="fa fa-check"></i><b>13</b> Collaborative Mapping</a>
<ul>
<li class="chapter" data-level="13.1" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#introduction-11"><i class="fa fa-check"></i><b>13.1</b> Introduction</a></li>
<li class="chapter" data-level="13.2" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#crowdsourcing"><i class="fa fa-check"></i><b>13.2</b> Crowdsourcing</a></li>
<li class="chapter" data-level="13.3" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#the-drawing-control"><i class="fa fa-check"></i><b>13.3</b> The drawing control</a></li>
<li class="chapter" data-level="13.4" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#working-with-drawn-items"><i class="fa fa-check"></i><b>13.4</b> Working with drawn items</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#printing-drawn-items-geojson"><i class="fa fa-check"></i><b>13.4.1</b> Printing drawn items GeoJSON</a></li>
<li class="chapter" data-level="13.4.2" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#expanded-geojson-viewer"><i class="fa fa-check"></i><b>13.4.2</b> Expanded GeoJSON viewer</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#submission-form"><i class="fa fa-check"></i><b>13.5</b> Submission form</a></li>
<li class="chapter" data-level="13.6" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#sending-features-to-the-database"><i class="fa fa-check"></i><b>13.6</b> Sending features to the database</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#setting-database-permissions"><i class="fa fa-check"></i><b>13.6.1</b> Setting database permissions</a></li>
<li class="chapter" data-level="13.6.2" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#adding-draw-control"><i class="fa fa-check"></i><b>13.6.2</b> Adding the drawing control</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="collaborative-mapping.html"><a href="collaborative-mapping.html#exercise-7"><i class="fa fa-check"></i><b>13.7</b> Exercise</a></li>
</ul></li>
<li class="part"><span><b>V Appendices</b></span></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="associated-files.html"><a href="associated-files.html"><i class="fa fa-check"></i><b>A</b> Associated Files</a></li>
<li class="chapter" data-level="B" data-path="list-of-examples.html"><a href="list-of-examples.html"><i class="fa fa-check"></i><b>B</b> List of Examples</a>
<ul>
<li class="chapter" data-level="B.1" data-path="list-of-examples.html"><a href="list-of-examples.html#main"><i class="fa fa-check"></i><b>B.1</b> Main</a></li>
<li class="chapter" data-level="B.2" data-path="list-of-examples.html"><a href="list-of-examples.html#additional"><i class="fa fa-check"></i><b>B.2</b> Additional</a>
<ul>
<li class="chapter" data-level="B.2.1" data-path="list-of-examples.html"><a href="list-of-examples.html#html-and-css"><i class="fa fa-check"></i><b>B.2.1</b> HTML and CSS</a></li>
<li class="chapter" data-level="B.2.2" data-path="list-of-examples.html"><a href="list-of-examples.html#javascript"><i class="fa fa-check"></i><b>B.2.2</b> JavaScript</a></li>
<li class="chapter" data-level="B.2.3" data-path="list-of-examples.html"><a href="list-of-examples.html#leaflet-1"><i class="fa fa-check"></i><b>B.2.3</b> Leaflet</a></li>
<li class="chapter" data-level="B.2.4" data-path="list-of-examples.html"><a href="list-of-examples.html#geo-processing"><i class="fa fa-check"></i><b>B.2.4</b> Geo-processing</a></li>
<li class="chapter" data-level="B.2.5" data-path="list-of-examples.html"><a href="list-of-examples.html#d-maps"><i class="fa fa-check"></i><b>B.2.5</b> 2.5D Maps</a></li>
<li class="chapter" data-level="B.2.6" data-path="list-of-examples.html"><a href="list-of-examples.html#d-maps-1"><i class="fa fa-check"></i><b>B.2.6</b> 3D maps</a></li>
<li class="chapter" data-level="B.2.7" data-path="list-of-examples.html"><a href="list-of-examples.html#animation"><i class="fa fa-check"></i><b>B.2.7</b> Animation</a></li>
<li class="chapter" data-level="B.2.8" data-path="list-of-examples.html"><a href="list-of-examples.html#real-time-data"><i class="fa fa-check"></i><b>B.2.8</b> Real-time data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="C" data-path="list-of-exercise-solutions.html"><a href="list-of-exercise-solutions.html"><i class="fa fa-check"></i><b>C</b> List of Exercise Solutions</a></li>
<li class="chapter" data-level="D" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html"><i class="fa fa-check"></i><b>D</b> BGU course 2021</a>
<ul>
<li class="chapter" data-level="D.1" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#place-and-time"><i class="fa fa-check"></i><b>D.1</b> Place and Time</a></li>
<li class="chapter" data-level="D.2" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#lecture-plan"><i class="fa fa-check"></i><b>D.2</b> Lecture plan</a></li>
<li class="chapter" data-level="D.3" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#project-submission-dates"><i class="fa fa-check"></i><b>D.3</b> Project submission dates</a></li>
<li class="chapter" data-level="D.4" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#additional-resources"><i class="fa fa-check"></i><b>D.4</b> Additional resources</a>
<ul>
<li class="chapter" data-level="D.4.1" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#html-css"><i class="fa fa-check"></i><b>D.4.1</b> HTML &amp; CSS</a></li>
<li class="chapter" data-level="D.4.2" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#javascript-1"><i class="fa fa-check"></i><b>D.4.2</b> JavaScript</a></li>
<li class="chapter" data-level="D.4.3" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#web-mapping"><i class="fa fa-check"></i><b>D.4.3</b> Web mapping</a></li>
<li class="chapter" data-level="D.4.4" data-path="bgu-course-2021.html"><a href="bgu-course-2021.html#postgis"><i class="fa fa-check"></i><b>D.4.4</b> PostGIS</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="E" data-path="projects.html"><a href="projects.html"><i class="fa fa-check"></i><b>E</b> Projects</a>
<ul>
<li class="chapter" data-level="E.1" data-path="projects.html"><a href="projects.html#overview-3"><i class="fa fa-check"></i><b>E.1</b> Overview</a></li>
<li class="chapter" data-level="E.2" data-path="projects.html"><a href="projects.html#carto-account"><i class="fa fa-check"></i><b>E.2</b> CARTO Account</a></li>
<li class="chapter" data-level="E.3" data-path="projects.html"><a href="projects.html#data"><i class="fa fa-check"></i><b>E.3</b> Data</a></li>
<li class="chapter" data-level="E.4" data-path="projects.html"><a href="projects.html#project-requirements"><i class="fa fa-check"></i><b>E.4</b> Project requirements</a>
<ul>
<li class="chapter" data-level="E.4.1" data-path="projects.html"><a href="projects.html#project-01"><i class="fa fa-check"></i><b>E.4.1</b> Project 01</a></li>
<li class="chapter" data-level="E.4.2" data-path="projects.html"><a href="projects.html#project-02"><i class="fa fa-check"></i><b>E.4.2</b> Project 02</a></li>
<li class="chapter" data-level="E.4.3" data-path="projects.html"><a href="projects.html#project-03"><i class="fa fa-check"></i><b>E.4.3</b> Project 03</a></li>
</ul></li>
<li class="chapter" data-level="E.5" data-path="projects.html"><a href="projects.html#submission"><i class="fa fa-check"></i><b>E.5</b> Submission</a></li>
<li class="chapter" data-level="E.6" data-path="projects.html"><a href="projects.html#grading"><i class="fa fa-check"></i><b>E.6</b> Grading</a></li>
</ul></li>
<li class="chapter" data-level="F" data-path="exam.html"><a href="exam.html"><i class="fa fa-check"></i><b>F</b> Exam</a>
<ul>
<li class="chapter" data-level="F.1" data-path="exam.html"><a href="exam.html#topics"><i class="fa fa-check"></i><b>F.1</b> Topics</a></li>
<li class="chapter" data-level="F.2" data-path="exam.html"><a href="exam.html#sample-questions"><i class="fa fa-check"></i><b>F.2</b> Sample questions</a>
<ul>
<li class="chapter" data-level="F.2.1" data-path="exam.html"><a href="exam.html#question-1"><i class="fa fa-check"></i><b>F.2.1</b> Question 1</a></li>
<li class="chapter" data-level="F.2.3" data-path="exam.html"><a href="exam.html#question-3"><i class="fa fa-check"></i><b>F.2.3</b> Question 3</a></li>
<li class="chapter" data-level="F.2.4" data-path="exam.html"><a href="exam.html#question-4"><i class="fa fa-check"></i><b>F.2.4</b> Question 4</a></li>
<li class="chapter" data-level="F.2.5" data-path="exam.html"><a href="exam.html#question-5"><i class="fa fa-check"></i><b>F.2.5</b> Question 5</a></li>
<li class="chapter" data-level="F.2.6" data-path="exam.html"><a href="exam.html#question-6"><i class="fa fa-check"></i><b>F.2.6</b> Question 6</a></li>
<li class="chapter" data-level="F.2.7" data-path="exam.html"><a href="exam.html#question-7"><i class="fa fa-check"></i><b>F.2.7</b> Question 7</a></li>
<li class="chapter" data-level="F.2.8" data-path="exam.html"><a href="exam.html#question-8"><i class="fa fa-check"></i><b>F.2.8</b> Question 8</a></li>
<li class="chapter" data-level="F.2.9" data-path="exam.html"><a href="exam.html#question-9"><i class="fa fa-check"></i><b>F.2.9</b> Question 9</a></li>
<li class="chapter" data-level="F.2.10" data-path="exam.html"><a href="exam.html#question-10"><i class="fa fa-check"></i><b>F.2.10</b> Question 10</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="G" data-path="additional-questions.html"><a href="additional-questions.html"><i class="fa fa-check"></i><b>G</b> Additional Questions</a>
<ul>
<li class="chapter" data-level="G.1" data-path="additional-questions.html"><a href="additional-questions.html#chapter-3"><i class="fa fa-check"></i><b>G.1</b> Chapter 3</a>
<ul>
<li class="chapter" data-level="G.1.1" data-path="additional-questions.html"><a href="additional-questions.html#modifying-global-variable"><i class="fa fa-check"></i><b>G.1.1</b> Modifying global variable</a></li>
<li class="chapter" data-level="G.1.2" data-path="additional-questions.html"><a href="additional-questions.html#insertingremoving-array-element"><i class="fa fa-check"></i><b>G.1.2</b> Inserting/removing array element</a></li>
<li class="chapter" data-level="G.1.3" data-path="additional-questions.html"><a href="additional-questions.html#object-oriented-language"><i class="fa fa-check"></i><b>G.1.3</b> Object Oriented language</a></li>
</ul></li>
<li class="chapter" data-level="G.2" data-path="additional-questions.html"><a href="additional-questions.html#chapter-4"><i class="fa fa-check"></i><b>G.2</b> Chapter 4</a>
<ul>
<li class="chapter" data-level="G.2.1" data-path="additional-questions.html"><a href="additional-questions.html#removing-collection-of-html-elements"><i class="fa fa-check"></i><b>G.2.1</b> Removing collection of HTML elements</a></li>
<li class="chapter" data-level="G.2.2" data-path="additional-questions.html"><a href="additional-questions.html#constraining-event-listener-frequency"><i class="fa fa-check"></i><b>G.2.2</b> Constraining event listener frequency</a></li>
<li class="chapter" data-level="G.2.3" data-path="additional-questions.html"><a href="additional-questions.html#saving-.getelementbyid-method-in-variable"><i class="fa fa-check"></i><b>G.2.3</b> Saving <code>.getElementById</code> method in variable</a></li>
</ul></li>
<li class="chapter" data-level="G.3" data-path="additional-questions.html"><a href="additional-questions.html#chapter-6"><i class="fa fa-check"></i><b>G.3</b> Chapter 6</a>
<ul>
<li class="chapter" data-level="G.3.1" data-path="additional-questions.html"><a href="additional-questions.html#routing"><i class="fa fa-check"></i><b>G.3.1</b> Routing</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="H" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html"><i class="fa fa-check"></i><b>H</b> Setting up an SQL API</a>
<ul>
<li class="chapter" data-level="H.1" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#introduction-12"><i class="fa fa-check"></i><b>H.1</b> Introduction</a></li>
<li class="chapter" data-level="H.2" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#computer-with-fixed-ip-address"><i class="fa fa-check"></i><b>H.2</b> Computer with fixed IP address</a></li>
<li class="chapter" data-level="H.3" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#installing-postgresql-postgis"><i class="fa fa-check"></i><b>H.3</b> Installing PostgreSQL and PostGIS</a></li>
<li class="chapter" data-level="H.4" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#loading-data-into-the-database"><i class="fa fa-check"></i><b>H.4</b> Loading data into the database</a></li>
<li class="chapter" data-level="H.5" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#adding-read-only-database-user"><i class="fa fa-check"></i><b>H.5</b> Adding a read-only database user</a></li>
<li class="chapter" data-level="H.6" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#installing-nodejs-and-required-modules"><i class="fa fa-check"></i><b>H.6</b> Installing Node.js and required modules</a></li>
<li class="chapter" data-level="H.7" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#creating-a-service"><i class="fa fa-check"></i><b>H.7</b> Creating a service</a></li>
<li class="chapter" data-level="H.8" data-path="setting-up-an-sql-api.html"><a href="setting-up-an-sql-api.html#testing-the-sql-api"><i class="fa fa-check"></i><b>H.8</b> Testing the SQL API</a></li>
</ul></li>
<li class="chapter" data-level="I" data-path="setting-up-a-static-server-using-r.html"><a href="setting-up-a-static-server-using-r.html"><i class="fa fa-check"></i><b>I</b> Setting up a static server using R</a>
<ul>
<li class="chapter" data-level="I.1" data-path="setting-up-a-static-server-using-r.html"><a href="setting-up-a-static-server-using-r.html#introduction-13"><i class="fa fa-check"></i><b>I.1</b> Introduction</a></li>
<li class="chapter" data-level="I.2" data-path="setting-up-a-static-server-using-r.html"><a href="setting-up-a-static-server-using-r.html#installing-r"><i class="fa fa-check"></i><b>I.2</b> Installing R</a></li>
<li class="chapter" data-level="I.3" data-path="setting-up-a-static-server-using-r.html"><a href="setting-up-a-static-server-using-r.html#installing-the-servr-package"><i class="fa fa-check"></i><b>I.3</b> Installing the <code>servr</code> package</a></li>
<li class="chapter" data-level="I.4" data-path="setting-up-a-static-server-using-r.html"><a href="setting-up-a-static-server-using-r.html#starting-the-server"><i class="fa fa-check"></i><b>I.4</b> Starting the server</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://bookdown.org/" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="index-2.html">Introduction to Web Mapping</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="spatial-queries-1" class="section level1" number="11">
<h1><span class="header-section-number">Chapter 11</span> Spatial Queries</h1>
<p><i>Last updated: 2021-08-24 14:54:59 </i></p>
<div id="introduction-9" class="section level2" number="11.1">
<h2><span class="header-section-number">11.1</span> Introduction</h2>
<p>In this chapter, we are going to integrate our plant observations web map with spatial SQL queries to selectively load data from the CARTO database, based on geographical proximity. Specifically, we will build a web map where the user can click on any location, and as a result the nearest <em>n</em> plants observations to the clicked location will be loaded from the database and displayed, along with straight-line paths towards those plants. You can see the final result in Figure <a href="spatial-queries-1.html#fig:example-11-04">11.8</a>.</p>
<p>We will build the web map going through several steps, each time adding more functionality:</p>
<ul>
<li>Adding a marker at the clicked location on the map (Section <a href="spatial-queries-1.html#getting-click-coordinates">11.2.1</a>)</li>
<li>Adding a <em>custom</em> marker at clicked location, to distinguish it from the observation markers (Section <a href="spatial-queries-1.html#adding-custom-marker">11.2.2</a>)</li>
<li>Finding <em>n</em> nearest features, using a spatial SQL query, and adding them on the map (Section <a href="spatial-queries-1.html#adding-nearest-points-to-map">11.4</a>)</li>
<li>Drawing line segments from clicked location to the nearest features (Section <a href="spatial-queries-1.html#drawing-line-connectors">11.5</a>)</li>
</ul>
</div>
<div id="adding-marker-on-click" class="section level2" number="11.2">
<h2><span class="header-section-number">11.2</span> Adding markers on click</h2>
<div id="getting-click-coordinates" class="section level3" number="11.2.1">
<h3><span class="header-section-number">11.2.1</span> Getting click coordinates</h3>
<p>Our first step towards a web map that queries the <code>plants</code> table based on spatial proximity is to mark the clicked location on the map, while capturing its coordinates. The coordinates will be stored, to pass them on with a spatial SQL query (Section <a href="databases.html#spatial-queries">9.6.4</a>). We start from the basic map <code>example-06-02.html</code> from Section <a href="leaflet.html#creating-a-basic-web-map">6.5</a> and make changes on top of it. First, we modify the initially displayed map extent to a larger one:</p>
<div class="sourceCode" id="cb374"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb374-1"><a href="spatial-queries-1.html#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> map <span class="op">=</span> L<span class="op">.</span><span class="fu">map</span>(<span class="st">&quot;map&quot;</span>)<span class="op">.</span><span class="fu">setView</span>([<span class="dv">32</span><span class="op">,</span> <span class="dv">35</span>]<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span></code></pre></div>
<p>Next, we add a layer group named <code>myLocation</code>. This layer group will contain the clicked location marker, created on map click. As we have seen in Sections <a href="geojson-1.html#adding-an-event-listener">7.6.4</a> and <a href="non-spatial-queries-1.html#automatic-updating">10.5.3</a>, using a layer group will make it easy to remove the old marker before adding a new one, in case the user changed his/her mind and subsequently clicked on a different location:</p>
<div class="sourceCode" id="cb375"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb375-1"><a href="spatial-queries-1.html#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> myLocation <span class="op">=</span> L<span class="op">.</span><span class="fu">layerGroup</span>()<span class="op">.</span><span class="fu">addTo</span>(map)<span class="op">;</span></span></code></pre></div>
<p>We then define an event listener, which will execute a function named <code>mapClick</code> each time the user clicks on the map. Remember the map click event and its <code>.latlng</code> property introduced in the <code>example-06-08.html</code> (Section <a href="leaflet.html#introducing-map-events">6.9</a>)? We use exactly the same principle here, only instead of adding a popup with the clicked coordinates in the clicked location, we are adding a <em>marker</em>. To do that, we first set the event listener for <code>"click"</code> events on the <code>map</code> object, referencing the <code>mapClick</code> function that we have yet to define:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb376-1"><a href="spatial-queries-1.html#cb376-1" aria-hidden="true" tabindex="-1"></a>map<span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;click&quot;</span><span class="op">,</span> mapClick)<span class="op">;</span></span></code></pre></div>
<p>Second, we define the <code>mapClick</code> function itself. The <code>mapClick</code> function needs to do two things:</p>
<ul>
<li><strong>Clear</strong> the <code>myLocation</code> layer of any previous markers, from a previously clicked location (if any)</li>
<li><strong>Add</strong> a new marker to the <code>myLocation</code> layer, at the clicked coordinates, using the <code>.latlng</code> property of the event object</li>
</ul>
<p>Here is the definition of the <code>mapClick</code> function:</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb377-1"><a href="spatial-queries-1.html#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mapClick</span>(e) {</span>
<span id="cb377-2"><a href="spatial-queries-1.html#cb377-2" aria-hidden="true" tabindex="-1"></a>    myLocation<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span>
<span id="cb377-3"><a href="spatial-queries-1.html#cb377-3" aria-hidden="true" tabindex="-1"></a>    L<span class="op">.</span><span class="fu">marker</span>(e<span class="op">.</span><span class="at">latlng</span>)<span class="op">.</span><span class="fu">addTo</span>(myLocation)<span class="op">;</span></span>
<span id="cb377-4"><a href="spatial-queries-1.html#cb377-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As a result, we now have a map (<code>example-11-01.html</code>) where the user can click, with the last clicked location displayed on the map (Figure <a href="spatial-queries-1.html#fig:example-11-01">11.1</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:example-11-01"></span>
<iframe src="examples/example-11-01.html" width="100%" height="400px">
</iframe>
<p class="caption">
FIGURE 11.1: <code>example-11-01.html</code> <a href="examples/example-11-01.html" title="View the Example" target="_blank">(Click to view this example on its own)</a>
</p>
</div>
</div>
<div id="adding-custom-marker" class="section level3" number="11.2.2">
<h3><span class="header-section-number">11.2.2</span> Adding a custom marker</h3>
<p>Shortly, we will write code to load plant observations next to to our clicked location, and display them as markers too (Figure <a href="spatial-queries-1.html#fig:example-11-03">11.7</a>). To distinguish the marker for the clicked location from the markers for the plant observations, we need to override the default blue marker settings in Leaflet and display a different type of marker for one of the two layers. For example, we can use a <em>red</em> marker for the clicked location and keep using the default <em>blue</em> markers for denoting the plant locations (Figure <a href="spatial-queries-1.html#fig:example-11-03">11.7</a>). To change marker appearance, however, we first need to understand a little better how it is defined in the first place.</p>
<p>The markers we see on a Leaflet map, created with <code>L.marker</code> (Section <a href="leaflet.html#adding-markers">6.6.2</a>), are in fact PNG images displayed at the specified locations placed on top of the map background. If you look closely, you will see that the default blue marker also has a “shadow” effect behind it, to create an illusion of depth, as if the marker “sticks out” of the map (Figure <a href="spatial-queries-1.html#fig:default-custom-icon">11.2</a>). The shadow is a PNG image too, displayed behind the PNG image of the marker itself. We can use the <em>Inspect Element</em> mode (Section <a href="html.html#inspecting-elements">1.9</a>) in the <strong>developer tools</strong> to figure out which PNG image is actually being loaded by Leaflet, and where it comes from (Figure <a href="spatial-queries-1.html#fig:inspecting-leaflet-icon">11.3</a>). Doing so reveals the following values for the <code>src</code> attributes of the <code>&lt;img&gt;</code> elements for the marker and marker shadow images:</p>
<ul>
<li><a href="../../localhost_8000/examples/css/images/marker-icon-2x.png" class="uri">http://localhost:8000/examples/css/images/marker-icon-2x.png</a></li>
<li><a href="../../localhost_8000/examples/css/images/marker-shadow.png" class="uri">http://localhost:8000/examples/css/images/marker-shadow.png</a></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:default-custom-icon"></span>
<img src="images/default_custom_icon.svg" alt="Default and custom images for drawing a Leaflet marker" width="25%" />
<p class="caption">
FIGURE 11.2: Default and custom images for drawing a Leaflet marker
</p>
</div>
<p>Note that the prefix <a href="http://localhost:8000/" class="uri">http://localhost:8000/</a> is specific to a locally-served (Section <a href="web-servers-1.html#local-with-python">5.6.2</a>) copy of the examples, and may be different when viewing them on a different server. The <em>local</em> Leaflet JavaScript library, which is included in <code>example-11-01.html</code>, looks for the marker PNG images in a sub-directory named <code>images</code> inside the directory where the <code>leaflet.css</code> file is placed (Section <a href="associated-files.html#associated-files">A</a>). That is the reason for us placing the images in the sub-directory, which we mentioned in Section <a href="leaflet.html#including-leaflet-css-js">6.5.7</a>. In case we use a <em>remote</em> copy of the Leaflet library (Section <a href="leaflet.html#including-leaflet-css-js">6.5.7</a>), the markers would have been loaded from remote PNG files, such as the following ones:</p>
<ul>
<li><a href="../../unpkg.com/leaflet%401.7.1/dist/images/marker-icon-2x.png" class="uri">https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon-2x.png</a></li>
<li><a href="../../unpkg.com/leaflet%401.7.1/dist/images/marker-shadow.png" class="uri">https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png</a></li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:inspecting-leaflet-icon"></span>
<img src="images/inspecting_leaflet_icon.png" alt="Inspecting Leaflet icon `&lt;img&gt;` element" width="100%" />
<p class="caption">
FIGURE 11.3: Inspecting Leaflet icon <code>&lt;img&gt;</code> element
</p>
</div>
<p>You can follow these URLs to download and inspect the PNG images in any graphical viewer or editor, such as <a href="https://en.wikipedia.org/wiki/Microsoft_Paint"><strong>Microsoft Paint</strong></a>.</p>
<p>To distinguish our clicked location from other markers on the map, we will use a different marker for the clicked location. In our example, we will use a marker PNG image, which is similar to the default one, only colored in red instead of blue (Figure <a href="spatial-queries-1.html#fig:default-custom-icon">11.2</a>). The PNG images for the red icon and its shadow are also included in the online book materials, in the <code>images</code> sub-directory (Appendix <a href="associated-files.html#associated-files">A</a>):</p>
<ul>
<li><code>images/redIcon.png</code></li>
<li><code>images/marker-shadow.png</code></li>
</ul>
<p>To set a custom Leaflet marker, based on the PNG images <code>redIcon.png</code> and <code>marker-shadow.png</code>, you need to place these files on your server. For example, the files can be placed in a folder named <code>images</code> within the root directory of the web page (see Section <a href="web-servers-1.html#file-structure">5.5.2</a>), as given in the online materials. A custom marker using these PNG images, assuming they are in the <code>images</code> folder, is then defined with the <code>L.icon</code> function as follows:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb378-1"><a href="spatial-queries-1.html#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> redIcon <span class="op">=</span> L<span class="op">.</span><span class="fu">icon</span>({</span>
<span id="cb378-2"><a href="spatial-queries-1.html#cb378-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">iconUrl</span><span class="op">:</span> <span class="st">&quot;images/redIcon.png&quot;</span><span class="op">,</span></span>
<span id="cb378-3"><a href="spatial-queries-1.html#cb378-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">shadowUrl</span><span class="op">:</span> <span class="st">&quot;images/marker-shadow.png&quot;</span><span class="op">,</span></span>
<span id="cb378-4"><a href="spatial-queries-1.html#cb378-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">iconAnchor</span><span class="op">:</span> [<span class="dv">13</span><span class="op">,</span> <span class="dv">41</span>]</span>
<span id="cb378-5"><a href="spatial-queries-1.html#cb378-5" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>The <code>L.icon</code> function requires a path to the PNG images for the icon (<code>iconUrl</code>), and, optionally, a path to the PNG image for the shadow (<code>shadowUrl</code>). The other important parameter is <code>iconAnchor</code>, which sets the anchor point, i.e., the exact icon image pixel which corresponds to the point coordinates where the marker is initiated. The custom icon object is assigned to a variable, hereby named <code>redIcon</code>, which we can later use to draw custom markers on the map with <code>L.marker</code>.</p>
<p>What is the meaning of <code>iconAnchor</code>, and why did we use the value of <code>[13, 41]</code>? The <code>iconAnchor</code> parameter specifies which pixel of the marker PNG image will be placed on the <code>[lon, lat]</code> point where the marker is initialized. To determine the right anchor point coordinates, we need to figure out the size (in pixels) of our particular marker, and the image region where we would like the anchor to be placed. The image size can be determined by viewing the PNG file properties, for example clicking on the file with the right mouse button, choosing <strong>Properties</strong> and then the <strong>Details</strong> tab. In our case, the size of the <code>redIcon.png</code> image is 25 by 41 pixels (Figure <a href="spatial-queries-1.html#fig:red-icon-properties">11.4</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:red-icon-properties"></span>
<img src="images/red_icon_properties_windows.png" alt="File properties for the red icon &lt;code&gt;redIcon.png&lt;/code&gt;. The highlighted entry shows image dimensions in pixels (25 x 41)." width="60%" />
<p class="caption">
FIGURE 11.4: File properties for the red icon <code>redIcon.png</code>. The highlighted entry shows image dimensions in pixels (25 x 41).
</p>
</div>
<p>Conventionally, image coordinates are set from a <code>[0, 0]</code> point at the top-left corner of the icon<a href="#fn103" class="footnote-ref" id="fnref103"><sup>103</sup></a>. The anchor point for our particular icon should be at its tip, at the bottom-middle. Starting from the top-left corner <code>[0, 0]</code>, this means going all the way <em>down</em> on the Y-axis, then half-way to the <em>right</em> on the X-axis. Since the PNG image size is <code>[25, 41]</code>, this means we set the the pixel on the center of the X-axis (<code>[13, ...]</code>) and bottom of the Y-axis (<code>[..., 41]</code>), thus the anchor value of <code>[13, 41]</code> (Figure <a href="spatial-queries-1.html#fig:icon-anchor">11.5</a>).</p>
<div class="figure" style="text-align: center"><span id="fig:icon-anchor"></span>
<img src="images/icon_anchor.png" alt="PNG image for the red marker &lt;code&gt;redIcon.png&lt;/code&gt;, with coordinates of the four corners and the coordinate of the marker anchor point. Note that the coordinate system starts from the top-left corner, with reversed Y-axis direction." width="150" height="30%"  />
<p class="caption">
FIGURE 11.5: PNG image for the red marker <code>redIcon.png</code>, with coordinates of the four corners and the coordinate of the marker anchor point. Note that the coordinate system starts from the top-left corner, with reversed Y-axis direction.
</p>
</div>
<p>Now that the <code>redIcon</code> object is ready and the PNG images are in place, we can replace the expression for adding a marker inside the map click event listener in <code>example-11-01.html</code>:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb379-1"><a href="spatial-queries-1.html#cb379-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span><span class="fu">marker</span>(e<span class="op">.</span><span class="at">latlng</span>)<span class="op">.</span><span class="fu">addTo</span>(myLocation)<span class="op">;</span></span></code></pre></div>
<p>with a new expression that loads our <em>custom</em> <code>redIcon</code> marker in <code>example-11-02.html</code>:</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb380-1"><a href="spatial-queries-1.html#cb380-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span><span class="fu">marker</span>(e<span class="op">.</span><span class="at">latlng</span><span class="op">,</span> {<span class="dt">icon</span><span class="op">:</span> redIcon})<span class="op">.</span><span class="fu">addTo</span>(myLocation)<span class="op">;</span></span></code></pre></div>
<p>The resulting map <code>example-11-02.html</code> is shown in Figure <a href="spatial-queries-1.html#fig:example-11-02">11.6</a>. Clicking on the map now adds the red marker icon instead of the default blue one.</p>
<div class="figure" style="text-align: center"><span id="fig:example-11-02"></span>
<iframe src="examples/example-11-02.html" width="100%" height="400px">
</iframe>
<p class="caption">
FIGURE 11.6: <code>example-11-02.html</code> <a href="examples/example-11-02.html" title="View the Example" target="_blank">(Click to view this example on its own)</a>
</p>
</div>
<p>You can use just about any PNG image as a marker icon this way, not just a differently-colored default marker. There are many places where you can find PNG images suitable for map markers, such as the <em>Maps and Navigation</em> <a href="https://www.flaticon.com/packs/maps-and-navigation-20">collection</a> on <a href="https://www.flaticon.com/" class="uri">https://www.flaticon.com</a> website<a href="#fn104" class="footnote-ref" id="fnref104"><sup>104</sup></a>.</p>
<blockquote>
<ul>
<li>Download one of the PNG images for custom map icons from <a href="https://www.flaticon.com/packs/maps-and-navigation-20" class="uri">https://www.flaticon.com/packs/maps-and-navigation-20</a>, or use any other small PNG image that you have.</li>
<li>Adapt <code>example-11-02.html</code> to display your custom icon instead of the red icon.</li>
</ul>
</blockquote>
</div>
</div>
<div id="spatial-postgis-operators" class="section level2" number="11.3">
<h2><span class="header-section-number">11.3</span> Spatial PostGIS operators</h2>
<div id="overview-postgis-operators" class="section level3" number="11.3.1">
<h3><span class="header-section-number">11.3.1</span> Overview</h3>
<p>Now that we know how to add a custom red marker on map click, we are going to add some code into our <code>mapClick</code> function incorporating a <em>spatial</em> SQL query (Section <a href="databases.html#spatial-queries">9.6.4</a>) to find the closest plants to the clicked location. As a result, each time the user clicks on a new point and <code>mapClick</code> adds a red marker, the function also queries for the nearest plants and displays them on the map (Figure <a href="spatial-queries-1.html#fig:example-11-03">11.7</a>). </p>
<p>As we have already discussed in Section <a href="databases.html#spatial-queries">9.6.4</a>, spatial databases are characterized by the fact that their tables may contain a geometry column. On CARTO, the geometry column is conventionally named <code>the_geom</code> (Section <a href="databases.html#query-example">9.7.2</a>). The geometry column is composed of encoded geometric data in the WKB format, which can be used to transform returned table records to spatial formats, such as GeoJSON. For example, in Chapters <a href="databases.html#databases">9</a>–<a href="non-spatial-queries-1.html#non-spatial-queries-1">10</a> we used <code>SELECT</code> statements to return GeoJSON objects based on data from the <code>plants</code> table on CARTO. These queries utilized the <code>the_geom</code> geometry column to create the <code>"geometry"</code> properties of the GeoJSON layer. However, the geometry column can also be used to make various spatial <em>calculations</em> on our data, using spatial SQL operators and functions. A very common example of a spatial calculation is the calculation of <strong>geographical distance</strong>. </p>
<p>In the next two sections (<a href="spatial-queries-1.html#geographical-distance">11.3.2</a>–<a href="spatial-queries-1.html#sphere-vs-spheroid">11.3.3</a>), we will discuss the structure of the required spatial SQL query to return nearest features. Then, in Section <a href="spatial-queries-1.html#adding-nearest-points-to-map">11.4</a>, we will see how to implement this type of SQL query in our Leaflet web map. </p>
</div>
<div id="geographical-distance" class="section level3" number="11.3.2">
<h3><span class="header-section-number">11.3.2</span> Geographical distance</h3>
<p>To find the five plant observations <em>nearest</em> to our clicked location, we can use the following query, which was introduced as an example of spatial SQL syntax in Section <a href="databases.html#spatial-queries">9.6.4</a>: </p>
<div class="sourceCode" id="cb381"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb381-1"><a href="spatial-queries-1.html#cb381-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> name_lat, obsr_date, ST_AsText(the_geom) <span class="kw">AS</span> geom </span>
<span id="cb381-2"><a href="spatial-queries-1.html#cb381-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> plants </span>
<span id="cb381-3"><a href="spatial-queries-1.html#cb381-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> </span>
<span id="cb381-4"><a href="spatial-queries-1.html#cb381-4" aria-hidden="true" tabindex="-1"></a>    the_geom:<span class="ch">:geography</span> <span class="op">&lt;-&gt;</span> </span>
<span id="cb381-5"><a href="spatial-queries-1.html#cb381-5" aria-hidden="true" tabindex="-1"></a>    ST_SetSRID(</span>
<span id="cb381-6"><a href="spatial-queries-1.html#cb381-6" aria-hidden="true" tabindex="-1"></a>      ST_MakePoint(<span class="fl">34.810696</span>, <span class="fl">31.895923</span>), <span class="dv">4326</span></span>
<span id="cb381-7"><a href="spatial-queries-1.html#cb381-7" aria-hidden="true" tabindex="-1"></a>    ):<span class="ch">:geography</span></span>
<span id="cb381-8"><a href="spatial-queries-1.html#cb381-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
<p>This query returns the nearest five observations from the <code>plants</code> table, based on distance to a specific point <code>[34.810696, 31.895923]</code>. In this section, we will explain the structure of the query more in depth. </p>
<p>First of all, as we already saw in Chapters <a href="databases.html#databases">9</a>–<a href="non-spatial-queries-1.html#non-spatial-queries-1">10</a>, limiting the returned table to the first <code>n</code> records can be triggered using the term <code>LIMIT n</code>, as in <code>LIMIT 5</code> or <code>LIMIT 25</code>. However, we need the five <em>nearest</em> plants, not just the five plants incidentally being first in terms of the table row ordering. This means the data need to be ordered before being returned. </p>
<p>As an example of <em>non-spatial</em> ordering, the table can be ordered with <code>ORDER BY</code> followed by column name(s) to select the five plant observations with the lowest (or highest) values for the given variable(s). We already saw one example of non-spatial ordering when producing the alphabetically ordered list of species in Section <a href="non-spatial-queries-1.html#finding-unique-values">10.4.3</a>. As another example, consider the following query, which returns the five <em>earliest</em> plant observation records. The <code>ORDER BY obsr_date</code> part means the table is ordered based on the values in the <code>obsr_date</code> (observation date) column: </p>
<div class="sourceCode" id="cb382"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb382-1"><a href="spatial-queries-1.html#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> name_lat, obsr_date, ST_AsText(the_geom) <span class="kw">AS</span> geom </span>
<span id="cb382-2"><a href="spatial-queries-1.html#cb382-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">FROM</span> plants </span>
<span id="cb382-3"><a href="spatial-queries-1.html#cb382-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ORDER</span> <span class="kw">BY</span> obsr_date</span>
<span id="cb382-4"><a href="spatial-queries-1.html#cb382-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
<p>which gives the following result: </p>
<pre class="text"><code>    name_lat    | obsr_date  |            geom
----------------+------------+----------------------------
 Iris haynei    | 1900-01-01 | POINT(35.654005 32.741372)
 Iris atrofusca | 1900-01-01 | POINT(35.193367 31.44711)
 Iris atrofusca | 1900-01-01 | POINT(35.189142 31.514754)
 Iris vartanii  | 1900-01-01 | POINT(35.139696 31.474149)
 Iris haynei    | 1900-01-01 | POINT(35.679761 32.770133)
(5 rows)</code></pre>
<p>Try the corresponding CARTO SQL API query, choosing the CSV output format, to examine the above result on your own: </p>
<pre class="text"><code>https://michaeldorman.carto.com/api/v2/sql?format=CSV&amp;q=
SELECT name_lat, obsr_date, ST_AsText(the_geom) AS geom 
FROM plants ORDER BY obsr_date LIMIT 5</code></pre>
<p>Indeed, all returned records are from the <code>1900-01-01</code>, which is the earliest date in the <code>obsr_date</code> field. <em>Spatial</em> ordering is similar, only that the table records are ordered based on their spatial arrangement, namely based on their distances to another spatial feature, or set of features. In other words, with spatial ordering, instead of ordering by non-spatial column values, we are ordering by geographical distances, which are calculated using the geometry column. In the above spatial query example for getting the five nearest points from a given location <code>[34.810696, 31.895923]</code>, the only part different from the non-spatial query example is basically just the <code>ORDER BY</code> term. Instead of the following <code>ORDER BY</code> term for non-spatial ordering, based on <code>obsr_date</code> values: </p>
<div class="sourceCode" id="cb385"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb385-1"><a href="spatial-queries-1.html#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> obsr_date</span></code></pre></div>
<p>we use the following <code>ORDER BY</code> term, for spatial ordering, based on distance from a specific point <code>[34.810696, 31.895923]</code>: </p>
<div class="sourceCode" id="cb386"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb386-1"><a href="spatial-queries-1.html#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> </span>
<span id="cb386-2"><a href="spatial-queries-1.html#cb386-2" aria-hidden="true" tabindex="-1"></a>  the_geom:<span class="ch">:geography</span> <span class="op">&lt;-&gt;</span> </span>
<span id="cb386-3"><a href="spatial-queries-1.html#cb386-3" aria-hidden="true" tabindex="-1"></a>  ST_SetSRID(ST_MakePoint(<span class="fl">34.810696</span>, <span class="fl">31.895923</span>), <span class="dv">4326</span>):<span class="ch">:geography</span></span></code></pre></div>
<p>The result of the spatial query is as follows: </p>
<pre class="text"><code>       name_lat       | obsr_date  |            geom
----------------------+------------+----------------------------
 Lavandula stoechas   | 1931-04-30 | POINT(34.808564 31.897377)
 Bunium ferulaceum    |            | POINT(34.808504 31.897328)
 Bunium ferulaceum    | 1930-02-23 | POINT(34.808504 31.897328)
 Silene modesta       | 1900-01-01 | POINT(34.822295 31.900125)
 Corrigiola litoralis | 2016-01-30 | POINT(34.825931 31.900792)
(5 rows)</code></pre>
<p>These are the locations of the five nearest plants to the specified location. You can see that the longitude and latitude values are fairly similar to <code>[34.810696, 31.895923]</code>, reflecting the fact that the points are proximate. Again, you can experiment with this query in the CARTO SQL API: </p>
<pre class="text"><code>https://michaeldorman.carto.com/api/v2/sql?format=CSV&amp;q=
SELECT name_lat, obsr_date, ST_AsText(the_geom) AS geom 
FROM plants 
ORDER BY the_geom::geography &lt;-&gt; ST_SetSRID(
ST_MakePoint(34.810696, 31.895923), 4326)::geography LIMIT 5</code></pre>
<p>As you probably noticed, the expression used for spatial ordering is more complicated than simply a column name such as <code>obsr_date</code>: </p>
<div class="sourceCode" id="cb389"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb389-1"><a href="spatial-queries-1.html#cb389-1" aria-hidden="true" tabindex="-1"></a>the_geom:<span class="ch">:geography</span> <span class="op">&lt;-&gt;</span> </span>
<span id="cb389-2"><a href="spatial-queries-1.html#cb389-2" aria-hidden="true" tabindex="-1"></a>ST_SetSRID(ST_MakePoint(<span class="fl">34.810696</span>, <span class="fl">31.895923</span>), <span class="dv">4326</span>):<span class="ch">:geography</span></span></code></pre></div>
<p>In addition to the geometry column name (<code>the_geom</code>), this particular <code>ORDER BY</code> term contains four spatial PostGIS functions and operators, which we will now explain: </p>
<ul>
<li><code>ST_MakePoint</code>—Creates a point geometry</li>
<li><code>ST_SetSRID</code>—Sets the coordinate reference system (CRS)</li>
<li><code>::geography</code>—Casts to the <code>geography</code> type</li>
<li><code>&lt;-&gt;</code>—Calculates 2D distance</li>
</ul>
<p>A two-dimensional point geometry is constructed using the <code>ST_MakePoint</code> function, given two coordinates <code>x</code> and <code>y</code>, in this case <code>34.810696</code> and <code>31.895923</code>, respectively. Thus, the expression <code>ST_MakePoint(34.810696, 31.895923)</code> defines a single geometry of type <code>"Point"</code>, which we can use in spatial calculations. The <code>ST_SetSRID</code> function then sets the coordinate reference system (CRS) for the geometry. The <code>4326</code> argument is the EPSG code of the WGS84 geographical projection (i.e., lon/lat) (Figure <a href="leaflet.html#fig:EPSG-4326-3857">6.1</a>). </p>
<p>The <code>::geography</code> part <a href="http://postgis.net/workshops/postgis-intro/geography.html"><em>casts</em></a> the geometry to a special type called <code>geography</code>, thus determining that what follows is a calculation with <strong>spherical geometry</strong>, which is the appropriate way to do distance-based calculations with lon/lat data. With <code>::geography</code>, distance calculations give the spherical <a href="https://en.wikipedia.org/wiki/Great_circle"><strong>Great Circle</strong></a> distance, in meters (Figure <a href="client-side-geoprocessing.html#fig:solution-12">12.10</a>). Omitting the <code>::geography</code> part is equivalent to using the default <code>::geometry</code> type, implying that what follows is a <strong>planar geometry</strong> calculation. Planar geometry calculations are only appropriate for projected data, which we do not use in this book. Using <code>::geometry</code> when calculating distances on lon/lat data gives straight-line euclidean distances, in degree units, which is almost always inappropriate. </p>
<p>The <code>&lt;-&gt;</code> operator returns the <a href="https://postgis.net/docs/geometry_distance_knn.html">2D distance</a> between two sets of geometries. Since we set <code>::geography</code>, the result represents spherical Great Circle distance in meters. In the present example, we are calculating the distances between <code>the_geom</code>, which is the geometry column of the <code>plants</code> table, and an individual point. The result is a series of distances in meters, corresponding to all features of the <code>plants</code> table. </p>
<p>Finally, the series of distances is passed to the <code>ORDER BY</code> keyword, thus rearranging the table based on the calculated distances, from the smallest to largest, i.e., from nearest observation to furthest. The <code>LIMIT 5</code> part then takes the top five records, which are the five nearest ones to <code>[34.810696, 31.895923]</code>.</p>
</div>
<div id="sphere-vs-spheroid" class="section level3" number="11.3.3">
<h3><span class="header-section-number">11.3.3</span> Sphere vs. spheroid</h3>
<p>As another demonstration of the four spatial PostGIS functions discussed in Section <a href="spatial-queries-1.html#geographical-distance">11.3.2</a> (above), consider the following small query. This query calculates the distance between two points <code>[0, 0]</code> and <code>[0, 1]</code> in geographic coordinates (lon/lat), i.e., the length of one degree of longitude along the equator: </p>
<div class="sourceCode" id="cb390"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb390-1"><a href="spatial-queries-1.html#cb390-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> </span>
<span id="cb390-2"><a href="spatial-queries-1.html#cb390-2" aria-hidden="true" tabindex="-1"></a>  (ST_SetSRID(ST_MakePoint(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">4326</span>):<span class="ch">:geography</span> <span class="op">&lt;-&gt;</span></span>
<span id="cb390-3"><a href="spatial-queries-1.html#cb390-3" aria-hidden="true" tabindex="-1"></a>  ST_SetSRID(ST_MakePoint(<span class="dv">1</span>, <span class="dv">0</span>), <span class="dv">4326</span>):<span class="ch">:geography</span>) <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb390-4"><a href="spatial-queries-1.html#cb390-4" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> dist_km;</span></code></pre></div>
<p>According to the result, the distance is <code>111.195</code> km: </p>
<pre class="text"><code>     dist_km
------------------
 111.195079734632
(1 row)</code></pre>
<p>In this query, we are manually constructing two points in lon/lat, <code>[0, 0]</code> and <code>[1, 0]</code>, using <code>ST_MakePoint</code>, <code>ST_SetSRID</code> and <code>::geography</code>. The 2D distance operator <code>&lt;-&gt;</code> is the applied on the points to calculate the Great Circle distance between them, in meters. Dividing the result by <code>1000</code> transforms the distance from meter to kilometer units<a href="#fn105" class="footnote-ref" id="fnref105"><sup>105</sup></a>. </p>
<p>The true distance between <code>[0, 0]</code> and <code>[1, 0]</code>, however, is <a href="https://en.wikipedia.org/wiki/Longitude#Length_of_a_degree_of_longitude"><code>111.320</code> km</a> and not <code>111.195</code>. What is the reason for the discrepancy? The reason is that the <code>&lt;-&gt;</code> operator, though using spherical geometry, relies on a <strong>sphere</strong> model of the earth, rather than the more accurate <strong>spheroid</strong> model. In PostGIS, the more accurate but somewhat slower distance calculation based on a spheroid can be obtained with <code>ST_Distance</code> instead of <code>&lt;-&gt;</code>, as in: </p>
<div class="sourceCode" id="cb392"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb392-1"><a href="spatial-queries-1.html#cb392-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> ST_distance(</span>
<span id="cb392-2"><a href="spatial-queries-1.html#cb392-2" aria-hidden="true" tabindex="-1"></a>  ST_SetSRID(ST_MakePoint(<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">4326</span>):<span class="ch">:geography</span>,</span>
<span id="cb392-3"><a href="spatial-queries-1.html#cb392-3" aria-hidden="true" tabindex="-1"></a>  ST_SetSRID(ST_MakePoint(<span class="dv">1</span>, <span class="dv">0</span>), <span class="dv">4326</span>):<span class="ch">:geography</span>) <span class="op">/</span> <span class="dv">1000</span></span>
<span id="cb392-4"><a href="spatial-queries-1.html#cb392-4" aria-hidden="true" tabindex="-1"></a><span class="kw">AS</span> dist_km;</span></code></pre></div>
<p>This gives the more accurate result of <code>111.319</code> km:</p>
<pre class="text"><code>     dist_km
-----------------
 111.31949079327
(1 row)</code></pre>
<p>Though <code>ST_distance</code> gives the more accurate estimate, the calculation takes longer. For example, finding the 5 nearest neighbors from the <code>plants</code> table took 0.17 seconds using the <code>&lt;-&gt;</code> operator, compared to 0.37 seconds with <code>ST_Distance</code>, on an average laptop computer. This is a more than twice longer calculation time. Although, in this particular example, exactly the same five plants are returned in both cases, theoretically the ordering may differ among the two methods in some cases, due to small differences in distance estimates between the sphere and spheroid models. In practice, the trade-off between speed and accuracy should always be considered when choosing the right distance-based calculation given the application requirements, dataset resolution and dataset size. With small amounts of data and/or high accuracy requirements <code>ST_Distance</code> should be preferred; otherwise the accuracy given by <code>&lt;-&gt;</code> may be sufficient.</p>
<blockquote>
<ul>
<li>What do you think will happen if we omit the <code>::geography</code> keyword from both places where it appears in the above query?</li>
<li>Check your answer using the CARTO SQL API.</li>
</ul>
</blockquote>
</div>
</div>
<div id="adding-nearest-points-to-map" class="section level2" number="11.4">
<h2><span class="header-section-number">11.4</span> Adding nearest points to map</h2>
<p>We are now ready to take the SQL spatial query from Section <a href="spatial-queries-1.html#geographical-distance">11.3.2</a> and incorporate it into the <code>mapClick</code> function, so that the nearest 25 plants are displayed along with the red marker. The key here is that we are going to make the spatial query <em>dynamic</em>, each time replacing the proximity search according to the location clicked by the user on the web map. Unlike in Section <a href="spatial-queries-1.html#geographical-distance">11.3.2</a>, where the longitude and latitude were hard-coded into the SQL query (<code>[34.810696, 31.895923]</code>), we are going to generate the SQL query by pasting user-clicked coordinates into the SQL query “template.” Specifically, we will use longitude and latitude returned from our map click event, <code>e.latlng</code> (Section <a href="spatial-queries-1.html#getting-click-coordinates">11.2.1</a>).</p>
<p>We proceed, modifying <code>example-11-02.html</code>. First, we add two more variable definitions: a layer group for the nearest plant markers (<code>plantLocations</code>), and the URL prefix for querying the CARTO SQL API (<code>url</code>). Along with the the layer group for the clicked location (<code>myLocation</code>), which we already defined in the previous example (Section <a href="spatial-queries-1.html#getting-click-coordinates">11.2.1</a>), the variable definition part in our <code>&lt;script&gt;</code> is now composed of the following three expressions:</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb394-1"><a href="spatial-queries-1.html#cb394-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> myLocation <span class="op">=</span> L<span class="op">.</span><span class="fu">layerGroup</span>()<span class="op">.</span><span class="fu">addTo</span>(map)<span class="op">;</span></span>
<span id="cb394-2"><a href="spatial-queries-1.html#cb394-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> plantLocations <span class="op">=</span> L<span class="op">.</span><span class="fu">layerGroup</span>()<span class="op">.</span><span class="fu">addTo</span>(map)<span class="op">;</span></span>
<span id="cb394-3"><a href="spatial-queries-1.html#cb394-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> url <span class="op">=</span> <span class="st">&quot;https://michaeldorman.carto.com/api/v2/sql?format=GeoJSON&amp;q=&quot;</span><span class="op">;</span></span></code></pre></div>
<p>The remaining code changes are all inside our <code>mapClick</code> function. In its new version, the function will not only display the clicked location, but also the locations of 25 nearest observations of rare plants. Recall that the previous version of the <code>mapClick</code> function in <code>example-11-02.html</code> (Section <a href="spatial-queries-1.html#getting-click-coordinates">11.2.1</a>) merely cleared the old marker and added a new one according to the <code>e.latlng</code> object:</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb395-1"><a href="spatial-queries-1.html#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mapClick</span>(e) {</span>
<span id="cb395-2"><a href="spatial-queries-1.html#cb395-2" aria-hidden="true" tabindex="-1"></a>    myLocation<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span>
<span id="cb395-3"><a href="spatial-queries-1.html#cb395-3" aria-hidden="true" tabindex="-1"></a>    L<span class="op">.</span><span class="fu">marker</span>(e<span class="op">.</span><span class="at">latlng</span><span class="op">,</span> {<span class="dt">icon</span><span class="op">:</span> redIcon})<span class="op">.</span><span class="fu">addTo</span>(myLocation)<span class="op">;</span></span>
<span id="cb395-4"><a href="spatial-queries-1.html#cb395-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>In the new version of the function, we add four new expressions. First, we define a new local variable <code>clickCoords</code> capturing the contents of <code>e.latlng</code> (Section <a href="leaflet.html#introducing-map-events">6.9</a>) for that particular event. This is just a convenience, for typing <code>clickCoords</code> instead of <code>e.latlng</code> in the various places where we will use the clicked coordinates in the new function code body:</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb396-1"><a href="spatial-queries-1.html#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> clickCoords <span class="op">=</span> e<span class="op">.</span><span class="at">latlng</span><span class="op">;</span></span></code></pre></div>
<p>Second, we make sure that the nearest plant observations are cleared between consecutive clicks, just like the red marker is. The following expression takes care of clearing any previously loaded <code>plantLocations</code> contents:</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb397-1"><a href="spatial-queries-1.html#cb397-1" aria-hidden="true" tabindex="-1"></a>plantLocations<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span></code></pre></div>
<p>In the third expression, we dynamically compose the SQL query to get 25 nearest records from the <code>plants</code> table, considering the clicked location. We basically replace the hard-coded lon/lat coordinates from the specific SQL query discussed in Section <a href="spatial-queries-1.html#geographical-distance">11.3.2</a> with the <code>lng</code> and <code>lat</code> properties of the <code>clickCoords</code> object. The result, named <code>sqlQueryClosest</code>, is the specific SQL query string needed to obtain the 25 nearest plant observations from our currently clicked location. This is conceptually similar to the way that we dynamically constructed an SQL query to select the observations of a particular species (Section <a href="non-spatial-queries-1.html#automatic-updating">10.5.3</a>):</p>
<div class="sourceCode" id="cb398"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb398-1"><a href="spatial-queries-1.html#cb398-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> sqlQueryClosest <span class="op">=</span> </span>
<span id="cb398-2"><a href="spatial-queries-1.html#cb398-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;SELECT name_lat, the_geom FROM plants&quot;</span> <span class="op">+</span> </span>
<span id="cb398-3"><a href="spatial-queries-1.html#cb398-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ORDER BY the_geom::geography &lt;-&gt; ST_SetSRID(ST_MakePoint(&quot;</span> <span class="op">+</span> </span>
<span id="cb398-4"><a href="spatial-queries-1.html#cb398-4" aria-hidden="true" tabindex="-1"></a>    clickCoords<span class="op">.</span><span class="at">lng</span> <span class="op">+</span> <span class="st">&quot;,&quot;</span> <span class="op">+</span> clickCoords<span class="op">.</span><span class="at">lat</span> <span class="op">+</span> </span>
<span id="cb398-5"><a href="spatial-queries-1.html#cb398-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;), 4326)::geography LIMIT 25&quot;</span><span class="op">;</span></span></code></pre></div>
<p>Fourth, we use the <code>sqlQueryClosest</code> string to request the nearest 25 observations from CARTO, and add them to the <code>plantLocations</code> layer. The popup, in this case, contains the Latin species name (<code>name_lat</code>) displayed in italics:</p>
<div class="sourceCode" id="cb399"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb399-1"><a href="spatial-queries-1.html#cb399-1" aria-hidden="true" tabindex="-1"></a><span class="fu">fetch</span>(url <span class="op">+</span> sqlQueryClosest)</span>
<span id="cb399-2"><a href="spatial-queries-1.html#cb399-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>(response) {</span>
<span id="cb399-3"><a href="spatial-queries-1.html#cb399-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb399-4"><a href="spatial-queries-1.html#cb399-4" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb399-5"><a href="spatial-queries-1.html#cb399-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>(data) {</span>
<span id="cb399-6"><a href="spatial-queries-1.html#cb399-6" aria-hidden="true" tabindex="-1"></a>        L<span class="op">.</span><span class="fu">geoJSON</span>(data<span class="op">,</span> {</span>
<span id="cb399-7"><a href="spatial-queries-1.html#cb399-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">onEachFeature</span><span class="op">:</span> <span class="kw">function</span>(feature<span class="op">,</span> layer) {</span>
<span id="cb399-8"><a href="spatial-queries-1.html#cb399-8" aria-hidden="true" tabindex="-1"></a>                layer<span class="op">.</span><span class="fu">bindPopup</span>(<span class="st">&quot;&lt;i&gt;&quot;</span> <span class="op">+</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name_lat</span> <span class="op">+</span> <span class="st">&quot;&lt;/i&gt;&quot;</span>)<span class="op">;</span></span>
<span id="cb399-9"><a href="spatial-queries-1.html#cb399-9" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb399-10"><a href="spatial-queries-1.html#cb399-10" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">addTo</span>(plantLocations)<span class="op">;</span></span>
<span id="cb399-11"><a href="spatial-queries-1.html#cb399-11" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span></code></pre></div>
<p>Here is the complete code for the new version of the <code>mapClick</code> function:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb400-1"><a href="spatial-queries-1.html#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mapClick</span>(e) {</span>
<span id="cb400-2"><a href="spatial-queries-1.html#cb400-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb400-3"><a href="spatial-queries-1.html#cb400-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get clicked coordinates</span></span>
<span id="cb400-4"><a href="spatial-queries-1.html#cb400-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> clickCoords <span class="op">=</span> e<span class="op">.</span><span class="at">latlng</span><span class="op">;</span></span>
<span id="cb400-5"><a href="spatial-queries-1.html#cb400-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb400-6"><a href="spatial-queries-1.html#cb400-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Clear map</span></span>
<span id="cb400-7"><a href="spatial-queries-1.html#cb400-7" aria-hidden="true" tabindex="-1"></a>    myLocation<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span>
<span id="cb400-8"><a href="spatial-queries-1.html#cb400-8" aria-hidden="true" tabindex="-1"></a>    plantLocations<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span>
<span id="cb400-9"><a href="spatial-queries-1.html#cb400-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb400-10"><a href="spatial-queries-1.html#cb400-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add location marker</span></span>
<span id="cb400-11"><a href="spatial-queries-1.html#cb400-11" aria-hidden="true" tabindex="-1"></a>    L<span class="op">.</span><span class="fu">marker</span>(clickCoords<span class="op">,</span> {<span class="dt">icon</span><span class="op">:</span> redIcon})<span class="op">.</span><span class="fu">addTo</span>(myLocation)<span class="op">;</span></span>
<span id="cb400-12"><a href="spatial-queries-1.html#cb400-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb400-13"><a href="spatial-queries-1.html#cb400-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set SQL query</span></span>
<span id="cb400-14"><a href="spatial-queries-1.html#cb400-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> sqlQueryClosest <span class="op">=</span> </span>
<span id="cb400-15"><a href="spatial-queries-1.html#cb400-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;SELECT name_lat, the_geom FROM plants&quot;</span> <span class="op">+</span> </span>
<span id="cb400-16"><a href="spatial-queries-1.html#cb400-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;ORDER BY the_geom::geography &lt;-&gt; ST_SetSRID(ST_MakePoint(&quot;</span> <span class="op">+</span> </span>
<span id="cb400-17"><a href="spatial-queries-1.html#cb400-17" aria-hidden="true" tabindex="-1"></a>        clickCoords<span class="op">.</span><span class="at">lng</span> <span class="op">+</span> <span class="st">&quot;,&quot;</span> <span class="op">+</span> clickCoords<span class="op">.</span><span class="at">lat</span> <span class="op">+</span> </span>
<span id="cb400-18"><a href="spatial-queries-1.html#cb400-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;), 4326)::geography LIMIT 25&quot;</span><span class="op">;</span></span>
<span id="cb400-19"><a href="spatial-queries-1.html#cb400-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb400-20"><a href="spatial-queries-1.html#cb400-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get GeoJSON &amp; add to map</span></span>
<span id="cb400-21"><a href="spatial-queries-1.html#cb400-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(url <span class="op">+</span> sqlQueryClosest)</span>
<span id="cb400-22"><a href="spatial-queries-1.html#cb400-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>(response) {</span>
<span id="cb400-23"><a href="spatial-queries-1.html#cb400-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()<span class="op">;</span></span>
<span id="cb400-24"><a href="spatial-queries-1.html#cb400-24" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb400-25"><a href="spatial-queries-1.html#cb400-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">then</span>(<span class="kw">function</span>(data) {</span>
<span id="cb400-26"><a href="spatial-queries-1.html#cb400-26" aria-hidden="true" tabindex="-1"></a>            L<span class="op">.</span><span class="fu">geoJSON</span>(data<span class="op">,</span> {</span>
<span id="cb400-27"><a href="spatial-queries-1.html#cb400-27" aria-hidden="true" tabindex="-1"></a>                <span class="dt">onEachFeature</span><span class="op">:</span> <span class="kw">function</span>(feature<span class="op">,</span> layer) {</span>
<span id="cb400-28"><a href="spatial-queries-1.html#cb400-28" aria-hidden="true" tabindex="-1"></a>                    layer<span class="op">.</span><span class="fu">bindPopup</span>(<span class="st">&quot;&lt;i&gt;&quot;</span> <span class="op">+</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name_lat</span> <span class="op">+</span> <span class="st">&quot;&lt;/i&gt;&quot;</span>)<span class="op">;</span></span>
<span id="cb400-29"><a href="spatial-queries-1.html#cb400-29" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb400-30"><a href="spatial-queries-1.html#cb400-30" aria-hidden="true" tabindex="-1"></a>            })<span class="op">.</span><span class="fu">addTo</span>(plantLocations)<span class="op">;</span></span>
<span id="cb400-31"><a href="spatial-queries-1.html#cb400-31" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb400-32"><a href="spatial-queries-1.html#cb400-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-33"><a href="spatial-queries-1.html#cb400-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The resulting map <code>example-11-03.html</code> is shown in Figure <a href="spatial-queries-1.html#fig:example-11-03">11.7</a>. The red marker denotes the clicked location, while the blue markers denote the 25 nearest plant observations loaded from the database.</p>
<div class="figure" style="text-align: center"><span id="fig:example-11-03"></span>
<iframe src="examples/example-11-03.html" width="100%" height="400px">
</iframe>
<p class="caption">
FIGURE 11.7: <code>example-11-03.html</code> <a href="examples/example-11-03.html" title="View the Example" target="_blank">(Click to view this example on its own)</a>
</p>
</div>
</div>
<div id="drawing-line-connectors" class="section level2" number="11.5">
<h2><span class="header-section-number">11.5</span> Drawing line connectors</h2>
<p>To highlight the direction and distance from the clicked location to each of the nearest plants, the final version <code>example-11-04.html</code> adds code for drawing <strong>line segments</strong> between the focal point and each observation (Figure <a href="spatial-queries-1.html#fig:example-11-04">11.8</a>). This is a common visualization technique, also known as a “spider diagram” or “desire lines” (e.g., in <a href="http://desktop.arcgis.com/en/arcmap/latest/extensions/business-analyst/create-spider-diagrams-desire-lines.htm">ArcGIS documentation</a>). Line segments are frequently used to highlight the association between a focal point or points, and their associated (usually nearest) surrounding points from a different layer. For example, the lines can be used to visualize the association between a set of business stores and the customers who are potentially affiliated with each store.</p>
<p>To draw each of the line segments connecting the red marker (clicked location) with one of the blue ones (plant observation), we can take the two pairs of coordinates and apply the <code>L.polyline</code> function (Section <a href="leaflet.html#adding-lines">6.6.3</a>) on them. The principle is similar to the function we wrote in the exercise for Chapter <a href="javascript-basics.html#javascript-basics">3</a> (Section <a href="javascript-basics.html#exercise-2">3.12</a>). Suppose that the clicked location coordinates are <code>[lon0, lat0]</code> and the coordinates of the nearest plant observations are <code>[lon1, lat1]</code>, <code>[lon2, lat2]</code>, <code>[lon3, lat3]</code>, etc. The coordinate arrays of the corresponding line segments, connecting each pair of points, are then:</p>
<ul>
<li><code>[[lon0, lat0], [lon1, lat1]]</code> for the first segment</li>
<li><code>[[lon0, lat0], [lon2, lat2]]</code> for the second segment</li>
<li><code>[[lon0, lat0], [lon3, lat3]]</code> for the third segment</li>
<li>etc.</li>
</ul>
<p>Each of these coordinate arrays can be passed to the <code>L.polyline</code> function to draw the corresponding segment connecting a pair of points, much like the line segment connecting Building 72 with the Library (Figure <a href="leaflet.html#fig:example-06-04">6.9</a>). Note that we will actually be using reversed coordinate pairs, such as <code>[lat0, lon0]</code>, as expected by all Leaflet functions for drawing shapes, including <code>L.polyline</code> (Section <a href="leaflet.html#creating-map-object">6.5.9</a>).</p>
<p>To implement the above procedure of drawing line segments, we first create yet another layer group named <code>lines</code> at the beginning of our script, right below the expressions where we already defined the <code>myLocation</code> and <code>plantLocations</code> layer groups:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb401-1"><a href="spatial-queries-1.html#cb401-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> lines <span class="op">=</span> L<span class="op">.</span><span class="fu">layerGroup</span>()<span class="op">.</span><span class="fu">addTo</span>(map)<span class="op">;</span></span></code></pre></div>
<p>Accordingly, inside the <code>mapClick</code> function we clear all previous line segments before new ones are drawn, with the following expression clearing the <code>lines</code> layer group, right below the expressions where we clear <code>myLocation</code> and <code>plantLocations</code>:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb402-1"><a href="spatial-queries-1.html#cb402-1" aria-hidden="true" tabindex="-1"></a>lines<span class="op">.</span><span class="fu">clearLayers</span>()<span class="op">;</span></span></code></pre></div>
<p>Moving on, we are ready to actually draw the line segments. Inside the <code>L.geoJSON</code> function call, in the previous <code>example-11-03.html</code> (Section <a href="spatial-queries-1.html#adding-nearest-points-to-map">11.4</a>) we only binded the Latin species name popup like so:</p>
<div class="sourceCode" id="cb403"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb403-1"><a href="spatial-queries-1.html#cb403-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span><span class="fu">geoJSON</span>(data<span class="op">,</span> {</span>
<span id="cb403-2"><a href="spatial-queries-1.html#cb403-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onEachFeature</span><span class="op">:</span> <span class="kw">function</span>(feature<span class="op">,</span> layer) {</span>
<span id="cb403-3"><a href="spatial-queries-1.html#cb403-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb403-4"><a href="spatial-queries-1.html#cb403-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Bind popup</span></span>
<span id="cb403-5"><a href="spatial-queries-1.html#cb403-5" aria-hidden="true" tabindex="-1"></a>        layer<span class="op">.</span><span class="fu">bindPopup</span>(<span class="st">&quot;&lt;i&gt;&quot;</span> <span class="op">+</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name_lat</span> <span class="op">+</span> <span class="st">&quot;&lt;i&gt;&quot;</span>)<span class="op">;</span></span>
<span id="cb403-6"><a href="spatial-queries-1.html#cb403-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb403-7"><a href="spatial-queries-1.html#cb403-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb403-8"><a href="spatial-queries-1.html#cb403-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">addTo</span>(plantLocations)<span class="op">;</span></span></code></pre></div>
<p>Now, in <code>example-11-04.html</code>, we add three more expressions inside the <code>onEachFeature</code> option. These expressions are used to draw a line segment between the “central” point where the red marker is, which is stored in <code>clickCoords</code>, and the currently-added GeoJSON point, which is given in <code>feature</code> as part of the <code>onEachFeature</code> iteration (Section <a href="symbology-and-interactivity.html#constructing-popups-from-data">8.5</a>):</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb404-1"><a href="spatial-queries-1.html#cb404-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span><span class="fu">geoJSON</span>(data<span class="op">,</span> {</span>
<span id="cb404-2"><a href="spatial-queries-1.html#cb404-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onEachFeature</span><span class="op">:</span> <span class="kw">function</span>(feature<span class="op">,</span> layer) {</span>
<span id="cb404-3"><a href="spatial-queries-1.html#cb404-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb404-4"><a href="spatial-queries-1.html#cb404-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Bind popup</span></span>
<span id="cb404-5"><a href="spatial-queries-1.html#cb404-5" aria-hidden="true" tabindex="-1"></a>        layer<span class="op">.</span><span class="fu">bindPopup</span>(<span class="st">&quot;&lt;i&gt;&quot;</span> <span class="op">+</span> feature<span class="op">.</span><span class="at">properties</span><span class="op">.</span><span class="at">name_lat</span> <span class="op">+</span> <span class="st">&quot;&lt;i&gt;&quot;</span>)<span class="op">;</span></span>
<span id="cb404-6"><a href="spatial-queries-1.html#cb404-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb404-7"><a href="spatial-queries-1.html#cb404-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Draw line segment</span></span>
<span id="cb404-8"><a href="spatial-queries-1.html#cb404-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> layerCoords <span class="op">=</span> feature<span class="op">.</span><span class="at">geometry</span><span class="op">.</span><span class="at">coordinates</span><span class="op">;</span></span>
<span id="cb404-9"><a href="spatial-queries-1.html#cb404-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> lineCoords <span class="op">=</span> [</span>
<span id="cb404-10"><a href="spatial-queries-1.html#cb404-10" aria-hidden="true" tabindex="-1"></a>            [clickCoords<span class="op">.</span><span class="at">lat</span><span class="op">,</span> clickCoords<span class="op">.</span><span class="at">lng</span>]<span class="op">,</span> </span>
<span id="cb404-11"><a href="spatial-queries-1.html#cb404-11" aria-hidden="true" tabindex="-1"></a>            [layerCoords[<span class="dv">1</span>]<span class="op">,</span> layerCoords[<span class="dv">0</span>]]</span>
<span id="cb404-12"><a href="spatial-queries-1.html#cb404-12" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">;</span></span>
<span id="cb404-13"><a href="spatial-queries-1.html#cb404-13" aria-hidden="true" tabindex="-1"></a>        L<span class="op">.</span><span class="fu">polyline</span>(lineCoords<span class="op">,</span> {</span>
<span id="cb404-14"><a href="spatial-queries-1.html#cb404-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">color</span><span class="op">:</span> <span class="st">&quot;red&quot;</span><span class="op">,</span> <span class="dt">weight</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="fl">0.75</span></span>
<span id="cb404-15"><a href="spatial-queries-1.html#cb404-15" aria-hidden="true" tabindex="-1"></a>        })<span class="op">.</span><span class="fu">addTo</span>(lines)<span class="op">;</span></span>
<span id="cb404-16"><a href="spatial-queries-1.html#cb404-16" aria-hidden="true" tabindex="-1"></a>                                </span>
<span id="cb404-17"><a href="spatial-queries-1.html#cb404-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb404-18"><a href="spatial-queries-1.html#cb404-18" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">addTo</span>(plantLocations)<span class="op">;</span></span></code></pre></div>
<p>The new code section, right below the <code>//Draw line segment</code> comment, is composed of three expressions, which we now discuss step by step.</p>
<p>In the first expression, we extract the coordinates of the current plant observation, and assign them to a variable named <code>layerCoords</code>. As discussed in Section <a href="symbology-and-interactivity.html#constructing-popups-from-data">8.5</a>, as part of the <code>onEachFeature</code> iteration, the currently processed GeoJSON feature is accessible through the <code>feature</code> parameter. Just like we are accessing the current species name with <code>feature.properties.name_lat</code> to include it in the popup, we can also extract the point coordinates with <code>feature.geometry.coordinates</code>. The <code>feature.geometry.coordinates</code> property of a GeoJSON <code>"Point"</code> geometry is an array of the form <code>[lon, lat]</code> (Section <a href="geojson-1.html#single-part-geometries">7.3.2.2</a>), which we store in a variable named <code>layerCoords</code>:</p>
<div class="sourceCode" id="cb405"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb405-1"><a href="spatial-queries-1.html#cb405-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> layerCoords <span class="op">=</span> feature<span class="op">.</span><span class="at">geometry</span><span class="op">.</span><span class="at">coordinates</span><span class="op">;</span></span></code></pre></div>
<p>In the second expression, we build the segment coordinates array by combining the coordinates of the focal point stored in <code>clickCoords</code> with the coordinates of the current plant observation stored in <code>layerCoords</code>. Again, while <code>layerCoords</code> are stored as <code>[lon, lat]</code> according to the GeoJSON specification, <code>L.polyline</code> expects <code>[lat, lon]</code> (Section <a href="leaflet.html#adding-lines">6.6.3</a>). This is why the <code>layerCoords</code> array is reversed with <code>[layerCoords[1], layerCoords[0]]</code>. The complete segment coordinates array is assigned into a variable named <code>lineCoords</code>:</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb406-1"><a href="spatial-queries-1.html#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> lineCoords <span class="op">=</span> [</span>
<span id="cb406-2"><a href="spatial-queries-1.html#cb406-2" aria-hidden="true" tabindex="-1"></a>    [clickCoords<span class="op">.</span><span class="at">lat</span><span class="op">,</span> clickCoords<span class="op">.</span><span class="at">lng</span>]<span class="op">,</span> </span>
<span id="cb406-3"><a href="spatial-queries-1.html#cb406-3" aria-hidden="true" tabindex="-1"></a>    [layerCoords[<span class="dv">1</span>]<span class="op">,</span> layerCoords[<span class="dv">0</span>]]</span>
<span id="cb406-4"><a href="spatial-queries-1.html#cb406-4" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span></code></pre></div>
<p>In the third expressions, <code>lineCoords</code> is passed to the <code>L.polyline</code> function to create a line layer object. The <code>.addTo</code> method is then applied, in order to add the segment to the <code>lines</code> layer group and thus actually draw it on the map:</p>
<div class="sourceCode" id="cb407"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb407-1"><a href="spatial-queries-1.html#cb407-1" aria-hidden="true" tabindex="-1"></a>L<span class="op">.</span><span class="fu">polyline</span>(lineCoords<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&quot;red&quot;</span><span class="op">,</span> <span class="dt">weight</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="fl">0.75</span>})</span>
<span id="cb407-2"><a href="spatial-queries-1.html#cb407-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">addTo</span>(lines)<span class="op">;</span></span></code></pre></div>
<p>The resulting map <code>example-11-04.html</code> is shown in Figure <a href="spatial-queries-1.html#fig:example-11-04">11.8</a>. Clicking on the map now displays both nearest plant observations and the connecting line segments.</p>
<div class="figure" style="text-align: center"><span id="fig:example-11-04"></span>
<iframe src="examples/example-11-04.html" width="100%" height="400px">
</iframe>
<p class="caption">
FIGURE 11.8: <code>example-11-04.html</code> <a href="examples/example-11-04.html" title="View the Example" target="_blank">(Click to view this example on its own)</a>
</p>
</div>
</div>
<div id="exercise-5" class="section level2" number="11.6">
<h2><span class="header-section-number">11.6</span> Exercise</h2>
<ul>
<li>Start with <code>example-11-04.html</code> and modify the code so that the popup for each of the nearest plants also specifies its <em>distance</em> to the queried point (Figure <a href="spatial-queries-1.html#fig:solution-11">11.9</a>).</li>
</ul>
<div class="figure" style="text-align: center"><span id="fig:solution-11"></span>
<iframe src="examples/solution-11.html" width="100%" height="400px">
</iframe>
<p class="caption">
FIGURE 11.9: <code>solution-11.html</code> <a href="examples/solution-11.html" title="View the Example" target="_blank">(Click to view this example on its own)</a>
</p>
</div>
<ul>
<li>To get the distances, you can use the following SQL query example which returns the five nearest plants along with the distance in <em>kilometers</em> to the specific point <code>[34.810696, 31.895923]</code>. The distances are given in an additional column named <code>dist_km</code>. </li>
</ul>
<div class="sourceCode" id="cb408"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb408-1"><a href="spatial-queries-1.html#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> name_lat, </span>
<span id="cb408-2"><a href="spatial-queries-1.html#cb408-2" aria-hidden="true" tabindex="-1"></a>  (</span>
<span id="cb408-3"><a href="spatial-queries-1.html#cb408-3" aria-hidden="true" tabindex="-1"></a>    the_geom:<span class="ch">:geography</span> <span class="op">&lt;-&gt;</span> </span>
<span id="cb408-4"><a href="spatial-queries-1.html#cb408-4" aria-hidden="true" tabindex="-1"></a>    ST_SetSRID(ST_MakePoint(<span class="fl">34.810696</span>, <span class="fl">31.895923</span>), <span class="dv">4326</span>):<span class="ch">:geography</span></span>
<span id="cb408-5"><a href="spatial-queries-1.html#cb408-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="op">/</span> <span class="dv">1000</span> <span class="kw">AS</span> dist_km, </span>
<span id="cb408-6"><a href="spatial-queries-1.html#cb408-6" aria-hidden="true" tabindex="-1"></a>  ST_AsText(the_geom) <span class="kw">AS</span> geom</span>
<span id="cb408-7"><a href="spatial-queries-1.html#cb408-7" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> plants </span>
<span id="cb408-8"><a href="spatial-queries-1.html#cb408-8" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> dist_km </span>
<span id="cb408-9"><a href="spatial-queries-1.html#cb408-9" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">5</span>;</span></code></pre></div>
<ul>
<li>The query gives the following result. Note the <code>dist_km</code> column, which contains the distances in kilometers: </li>
</ul>
<pre class="text"><code>       name_lat       |      dist_km      |            geom
----------------------+-------------------+----------------------------
 Lavandula stoechas   | 0.258166195505697 | POINT(34.808564 31.897377)
 Bunium ferulaceum    |  0.25928724896688 | POINT(34.808504 31.897328)
 Bunium ferulaceum    |  0.25928724896688 | POINT(34.808504 31.897328)
 Silene modesta       |  1.19050813583538 | POINT(34.822295 31.900125)
 Corrigiola litoralis |  1.53676126266166 | POINT(34.825931 31.900792)
(5 rows)</code></pre>
<ul>
<li>Here is the corresponding CARTO SQL API query you can experiment with: </li>
</ul>
<pre class="text"><code>https://michaeldorman.carto.com/api/v2/sql?format=CSV&amp;q=
SELECT name_lat, (the_geom::geography &lt;-&gt; 
ST_SetSRID(ST_MakePoint(34.810696, 31.895923), 4326
)::geography) / 1000 AS dist_km, ST_AsText(the_geom) as geom
FROM plants ORDER BY dist_km LIMIT 5</code></pre>
<ul>
<li>Remember that in the actual code you need to use <code>format=GeoJSON</code> instead of <code>format=CSV</code>, and <code>the_geom</code> instead of <code>ST_AsText(the_geom)</code> to get GeoJSON rather than CSV. It is also useful to round the distance values before putting them into the popup (e.g., to two decimal places, as shown in Figure <a href="spatial-queries-1.html#fig:solution-11">11.9</a>). This can be done with JavaScript, applying the <code>.toFixed</code> method with the required number of digits on the numeric variable: </li>
</ul>
<div class="sourceCode" id="cb411"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb411-1"><a href="spatial-queries-1.html#cb411-1" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="fl">2.321342</span><span class="op">;</span></span>
<span id="cb411-2"><a href="spatial-queries-1.html#cb411-2" aria-hidden="true" tabindex="-1"></a>x<span class="op">.</span><span class="fu">toFixed</span>(<span class="dv">2</span>)<span class="op">;</span>  <span class="co">// Returns &quot;2.32&quot;</span></span></code></pre></div>

</div>
</div>



<div class="footnotes">
<hr />
<ol start="103">
<li id="fn103"><p>Measuring the coordinates from top-left and using an inverted Y-axis (values increase when moving <em>down</em>) is an old convention in computer graphics, emerging in many different situations. Going back to <code>example-04-07.html</code> (Section <a href="javascript-interactivity.html#the-event-object">4.10</a>), you will see that mouse coordinates in the browser window are also measured from the top-left corner.<a href="spatial-queries-1.html#fnref103" class="footnote-back">↩︎</a></p></li>
<li id="fn104"><p>For other examples of using custom icons in Leaflet, check out the <em>Leaflet Custom Markers</em> tutorial (<a href="https://leafletjs.com/examples/custom-icons/" class="uri">https://leafletjs.com/examples/custom-icons/</a>) and the <em>DUSPviz Map Design</em> tutorial (<a href="http://duspviz.mit.edu/web-map-workshop/map-symbolization/" class="uri">http://duspviz.mit.edu/web-map-workshop/map-symbolization/</a>).<a href="spatial-queries-1.html#fnref104" class="footnote-back">↩︎</a></p></li>
<li id="fn105"><p>Note that this query does not use data from any table, because it calculates distance between two points created as part of the query itself.<a href="spatial-queries-1.html#fnref105" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="non-spatial-queries-1.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="client-side-geoprocessing.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": null,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toc_depth": 2,
"search": false
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "../../mathjax.rstudio.com/2.7.2/MathJaxb198.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>


<!-- Mirrored from 132.72.155.230:3838/js/spatial-queries-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 10 Jan 2022 06:44:49 GMT -->
</html>
